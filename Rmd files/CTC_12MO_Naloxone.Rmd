---
title: "Naloxone12moCTC"
author: "Elizabeth Kinnard"
date: "10/18/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, eval=T, warning = FALSE, message = FALSE, global.par=TRUE)
knitr::opts_knit$set(root.dir="~/Documents/GitHub/lizzyandshelley/Dataset")
knitr::opts_chunk$set(tidy.opts=list(width.cutoff=85),tidy=TRUE)
```

Open packages.
```{r}
library(base)
library(knitr)
library(dplyr)
library(here)
library(foreign)
library(labelled)
library(dplyr)
library(reshape2)
library(tableone)
library(forcats)
library(geepack)
library(doBy)
library(blm)
library(lmtest)
library(foreign)
library(MASS)
```

Open working directory and load/label the data.
```{r}
#set working directory
setwd("~/Documents/GitHub/lizzyandshelley/Dataset") #LIZZY

#load the data
df <- read.spss("CTC12month.SAV", use.value.labels = TRUE, to.data.frame=TRUE)
```

Get variable labels.
```{r, echo=F, eval=F}
#get variable labels
attr(df, "variable.labels")
df.labels <- as.data.frame(attr(df, "variable.labels"))
QDSlabels <- data.frame(rownames(df.labels))
df.labels <- cbind(QDSlabels, df.labels)
names(df.labels) <- c("VAR_ID", "description")
rm(QDSlabels)

#USE THIS CODE TO LOOK UP A VARIABLE DESCRIPTION
#df.labels$description[df.labels$VAR_ID=="GENDER"]
```

Subset the data to delete all rows that are entirely NA (since they didn't show up to 12 month visit).
```{r}
df <- df[rowSums(is.na(df)) < 600,] #rows reduced from N=984 to N=536 people

#EXAMPLES OF SUBSETTING
#df <- subset(df, SUMINJ>0)
#df <- subset(df, IJWOTH_3cat>0) 
```

Descriptives of overdose and naloxone variables.
```{r}
#ODP6M: Overdosed in the last 6 months
#In the last 6 months, have you overdosed?
tbl.ODP6M <- table(df$ODP6M, useNA = "ifany")
tbl.ODP6M
prop.table(tbl.ODP6M)

#ODTIMES: Times overdosed in the last 6 months
#How many times did you overdose in the last 6 months?
tbl.ODTIMES <- table(df$ODTIMES, useNA = "ifany")  
tbl.ODTIMES 
prop.table(tbl.ODTIMES)

#FENTOD: Number of fentanyl related overdoses
#In the last 6 months, when you overdosed, how many times had you been using Fentanyl 
#or drugs with Fentanyl in it?
tbl.FENTOD <- table(df$FENTOD, useNA = "ifany")  
tbl.FENTOD
prop.table(tbl.FENTOD)

#ODDRUG: Drugs used when overdosed the last time
#The last time you overdosed, what drug or drugs had you been using?  Check all that apply
table(df$ODDRUG, useNA = "ifany")    

table(df$ODDRUGA, useNA = "ifany") #Crack cocaine
table(df$ODDRUGB, useNA = "ifany") #Powder cocaine
table(df$ODDRUGC, useNA = "ifany") #Methamphetamine
table(df$ODDRUGD, useNA = "ifany") #Heroin (by itself)
table(df$ODDRUGE, useNA = "ifany") #Speedball (heroin mixed with cocaine or crack)
table(df$ODDRUGF, useNA = "ifany") #Goofball (heroin mixed with speed)
table(df$ODDRUGG, useNA = "ifany") #Non-opiate pain relievers (percocet, percodan, darvon)
table(df$ODDRUGH, useNA = "ifany") #Opiates (vicodin, oxycontin, dilaudid)
table(df$ODDRUGI, useNA = "ifany") #Tranquilizers (klonopin, xanax, valium, atavan)
table(df$ODDRUGJ, useNA = "ifany") #Sedatives (restoril, tuinal, phenobarbatal)
table(df$ODDRUGK, useNA = "ifany") #Stimulants (ritalin, aderall, methadrine, bezedrine)
table(df$ODDRUGL, useNA = "ifany") #Methadone
table(df$ODDRUGM, useNA = "ifany") #Alcohol
table(df$ODDRUGN, useNA = "ifany") #Fentanyl or drugs w/fentanyl

#WOD6M: Witnessed an overdose in the last 6 months
#In the last 6 months, have you witnessed a heroin or opiate overdose?
tbl.WOD6M <- table(df$WOD6M, useNA = "ifany")   
tbl.WOD6M
prop.table(tbl.WOD6M)

#WODX6M: Number of witnessed overdoses in the last 6 months
#In the last 6 months, how many heroin or opiate overdoses have you witnessed?
tbl.WODX6M <- table(df$WODX6M, useNA = "ifany")   
tbl.WODX6M
prop.table(tbl.WODX6M)

#NARCAN: More than one dose of narcan to revive person
#Of the overdoses you witnessed where naloxone was used, did any of them require more than
#one dose to revive the person to the best of your knowledge?
tbl.NARCAN <- table(df$NARCAN, useNA = "ifany")   
tbl.NARCAN 
prop.table(tbl.NARCAN)

#RIGID: Rigidty or seizures during the overdose
#During the overdose(s) that you witnessed, did any one of the victims have immediate body 
#rigidity or seizures?
tbl.RIGID <- table(df$RIGID, useNA = "ifany") 
tbl.RIGID 
prop.table(tbl.RIGID)

#IMMED: Any immediate overdoses
#Of the overdoses you witnessed, did any of the victims overdose immediately or shortly 
#after taking their shot?
tbl.IMMED <- table(df$IMMED, useNA = "ifany") 
tbl.IMMED 
prop.table(tbl.IMMED)

#USEDNAL: Times naloxone used by bystander to prevent overdose in the last 30 days
#In the last 6 months, how many of these witnessed overdoses did you or someone else 
#who was not an EMT or police officer use naloxone or narcan?
tbl.USEDNAL <- table(df$USEDNAL, useNA = "ifany") 
tbl.USEDNAL 
prop.table(tbl.USEDNAL)

#OD911: Number of witnessed od where 911 was called in the last 30 days
#In the last 6 months, how many of these witnessed overdoses did you or someone else call 911?
tbl.OD911 <- table(df$OD911, useNA = "ifany") 
tbl.OD911
prop.table(tbl.OD911)

#ODTRAIN: Have you ever participated in overdose prevention training?
#Have you ever participated in overdose prevention training?
tbl.ODTRAIN <- table(df$ODTRAIN, useNA = "ifany") 
tbl.ODTRAIN
prop.table(tbl.ODTRAIN)

#ODTBY: OD training from whom
#From whom did you receive overdose prevention training? 
table(df$ODTBY, useNA = "ifany") 

table(df$ODTBYA, useNA = "ifany") #Needle exchange
table(df$ODTBYB, useNA = "ifany") #Another drug user
table(df$ODTBYC, useNA = "ifany") #Another community member
table(df$ODTBYD, useNA = "ifany") #A family member
table(df$ODTBYE, useNA = "ifany") #Pharmacy
table(df$ODTBYF, useNA = "ifany") #Community clinic
table(df$ODTBYG, useNA = "ifany") #Hospital
table(df$ODTBYH, useNA = "ifany") #Jail or prison
table(df$ODTBYI, useNA = "ifany") #Other

#ODTOTH:Overdose training by other organization
#What is the other organization or entity that provided you with overdose training?
tbl.ODTOTH <- table(df$ODTOTH, useNA = "ifany") 
tbl.ODTOTH 

#NALEVER: Ever received naloxone 
#Have you ever received naloxone (including narcan, intranasal narcan, and/or autoinjector 
#of naloxone to use on yourself or other people?
tbl.NALEVER <- table(df$NALEVER, useNA = "ifany") 
tbl.NALEVER 
prop.table(tbl.NALEVER)

#NAL6MOS: Received naloxone in the last 6 months 
#Have you received naloxone in the last 6 months?
tbl.NAL6MOS <- table(df$NAL6MOS, useNA = "ifany")
tbl.NAL6MOS
prop.table(tbl.NAL6MOS)

#NAL6MOSNEW: Creating new variable combining NALEVER AND NAL6MOS so that those who answered "No" to NALEVER are also "No" on NAL6MOS
#crosstab of NALEVER and NAL6MOS
table(df$NALEVER, df$NAL6MOS, useNA = "ifany")

df$NAL6MOS.new <- ifelse(df$NALEVER=="Yes" & df$NAL6MOS=="Yes", 1, ifelse(df$NALEVER=="Yes" & df$NAL6MOS=="No", 0, ifelse(df$NALEVER=="No", 0, NA)))

tbl.NAL6MOS.new <- table(df$NAL6MOS.new, useNA = "ifany")
tbl.NAL6MOS.new
prop.table(tbl.NAL6MOS.new)

#NAL6ORG: Naloxone from whom in the last 6 months
#From whom did you receive naloxone, narcan, intranasal narcan, and/or autoinjector/evzio in the last 6 months?  
table(df$NAL6ORG, useNA = "ifany") 

table(df$NAL6ORGA, useNA = "ifany") #Needle exchange
table(df$NAL6ORGB, useNA = "ifany") #Another drug user
table(df$NAL6ORGC, useNA = "ifany") #Another community member
table(df$NAL6ORGD, useNA = "ifany") #A family member
table(df$NAL6ORGE, useNA = "ifany") #Pharmacy
table(df$NAL6ORGF, useNA = "ifany") #Community clinic
table(df$NAL6ORGG, useNA = "ifany") #Hospital
table(df$NAL6ORGH, useNA = "ifany") #Jail or prison
table(df$NAL6ORGI, useNA = "ifany") #Other

#OTHNORG: Other organization that provided naloxone in the last 6 months
#What is the other organization or entity that provided you with naloxone in the last 6 months?
table(df$OTHNORG, useNA = "ifany") 

#NALUSED:Used naloxone in the last 6 months
#Have you used your Naloxone in the last 6 months?
tbl.NALUSED <- table(df$NALUSED, useNA = "ifany") 
tbl.NALUSED 
prop.table(tbl.NALUSED)

#NALOSE: Lost naloxone in the last 6 months
#Have you lost your Naloxone in the last 6 months?
tbl.NALOSE <- table(df$NALOSE, useNA = "ifany") 
tbl.NALOSE 
prop.table(tbl.NALOSE)

#NALUSEandorLOSE: Have you used and/or used your naloxone in the last 6 months?
table(df$NALUSED, df$NALOSE, useNA = "ifany")

df$NALUSEandorLOSE <- ifelse((df$NALUSED=="Yes" | df$NALOSE=="Yes"), 1, 0)

tbl.NALUSEandorLOSE <- table(df$NALUSEandorLOSE, useNA = "ifany") 
tbl.NALUSEandorLOSE  
prop.table(tbl.NALUSEandorLOSE)

#NALFILL: Got a refill of naloxone in the last 6 months
#After using or losing your naloxone, did you get a replacement or refill?
tbl.NALFILL <- table(df$NALFILL, useNA = "ifany") 
tbl.NALFILL
prop.table(tbl.NALFILL)

#TMEFILL: Days it took to refill or replace naloxone.
#How long after using or losing your Naloxone, did you get a replacement or refill?
tbl.TMEFILL <- table(df$TMEFILL, useNA = "ifany") 
tbl.TMEFILL 
prop.table(tbl.TMEFILL)

#NALPRVD: Who provided the naloxone replacement or refill
#From whom did you receive your naloxone replacement or refill? 
table(df$NALPRVD, useNA = "ifany") 

table(df$NALPRVDA, useNA = "ifany") #Needle exchange
table(df$NALPRVDB, useNA = "ifany") #Another drug user
table(df$NALPRVDC, useNA = "ifany") #Another community member
table(df$NALPRVDD, useNA = "ifany") #A family member
table(df$NALPRVDE, useNA = "ifany") #Pharmacy
table(df$NALPRVDF, useNA = "ifany") #Community clinic
table(df$NALPRVDG, useNA = "ifany") #Hospital
table(df$NALPRVDH, useNA = "ifany") #Jail or prison
table(df$NALPRVDI, useNA = "ifany") #Other

#OTHPRON: Replacement naloxone provided by what other organization
#What is the other organization or entity that provided you with naloxone dose replacement or refill?
table(df$OTHPRON, useNA = "ifany") #Other

#NALOWN: Own a dose of naloxone
#Do you currently have at least one dose of naloxone? (By this, we mean you possess 
#or own your own naloxone dose)
tbl.NALOWN <- table(df$NALOWN, useNA = "ifany")
tbl.NALOWN
prop.table(tbl.NALOWN)

#NALAVAIL: Naloxone available 
#In the last 6 months, when you injected drugs, how often did you or someone else around you have naloxone in the event of an overdose? 
tbl.NALAVAIL <- table(df$NALAVAIL, useNA = "ifany")
tbl.NALAVAIL 
prop.table(tbl.NALAVAIL)
```


Bar charts using counts for the cascade, whole sample (N=536).
```{r}
#NALEVER: Ever received naloxone 
#Have you ever received naloxone (including narcan, intranasal narcan, and/or autoinjector 
#of naloxone to use on yourself or other people?
tbl.NALEVER 

#NAL6MOS: Received naloxone in the last 6 months 
#Have you received naloxone in the last 6 months?
#tbl.NAL6MOS

#NAL6MOS.new: Received naloxone in the last 6 months (combined NALEVER and NAL6MOS to make NAL6MOS.new)
#Have you received naloxone in the last 6 months?
tbl.NAL6MOS.new

#NALOWN: Own a dose of naloxone
#Do you currently have at least one dose of naloxone? (By this, we mean you possess 
#or own your own naloxone dose)
tbl.NALOWN

#NALUSEandorLOSE: Have you used and/or used your naloxone in the last 6 months?
tbl.NALUSEandorLOSE

#NALFILL: Got a refill of naloxone in the last 6 months
#After using or losing your naloxone, did you get a replacement or refill?
tbl.NALFILL
```


Bar charts using counts for San Francisco (N=312).
```{r}
df_SF <- subset(df, LOCALID == "San Francisco")

#NALEVER: Ever received naloxone 
#Have you ever received naloxone (including narcan, intranasal narcan, and/or autoinjector 
#of naloxone to use on yourself or other people?
table(df_SF$NALEVER, useNA = "ifany") 

#NAL6MOS: Received naloxone in the last 6 months 
#Have you received naloxone in the last 6 months?
#table(df_SF$NAL6MOS, useNA = "ifany")

#NAL6MOS.new: Received naloxone in the last 6 months (combined NALEVER and NAL6MOS to make NAL6MOS.new)
#Have you received naloxone in the last 6 months?
df_SF$NAL6MOS.new <- ifelse(df_SF$NALEVER=="Yes" & df_SF$NAL6MOS=="Yes", 1, ifelse(df_SF$NALEVER=="Yes" & df_SF$NAL6MOS=="No", 0, ifelse(df_SF$NALEVER=="No", 0, NA)))

table(df_SF$NAL6MOS.new, useNA = "ifany")

#NALOWN: Own a dose of naloxone
#Do you currently have at least one dose of naloxone? (By this, we mean you possess 
#or own your own naloxone dose)
table(df_SF$NALOWN, useNA = "ifany") 

#NALUSEandorLOSE: Have you used and/or used your naloxone in the last 6 months?
df_SF$NALUSEandorLOSE <- ifelse((df_SF$NALUSED=="Yes" | df_SF$NALOSE=="Yes"), 1, 0)
table(df_SF$NALUSEandorLOSE, useNA = "ifany") 

#NALFILL: Got a refill of naloxone in the last 6 months
#After using or losing your naloxone, did you get a replacement or refill?
table(df_SF$NALFILL, useNA = "ifany") 
```


Bar charts using counts for Los Angeles (N=224).
```{r}
df_LA <- subset(df, LOCALID == "Los Angeles")

#NALEVER: Ever received naloxone 
#Have you ever received naloxone (including narcan, intranasal narcan, and/or autoinjector 
#of naloxone to use on yourself or other people?
table(df_LA$NALEVER, useNA = "ifany") 

#NAL6MOS: Received naloxone in the last 6 months 
#Have you received naloxone in the last 6 months?
#table(df_LA$NAL6MOS, useNA = "ifany")

#NAL6MOS.new: Received naloxone in the last 6 months (combined NALEVER and NAL6MOS to make NAL6MOS.new)
#Have you received naloxone in the last 6 months?
df_LA$NAL6MOS.new <- ifelse(df_LA$NALEVER=="Yes" & df_LA$NAL6MOS=="Yes", 1, ifelse(df_LA$NALEVER=="Yes" & df_LA$NAL6MOS=="No", 0, ifelse(df_LA$NALEVER=="No", 0, NA)))

table(df_LA$NAL6MOS.new, useNA = "ifany")

#NALOWN: Own a dose of naloxone
#Do you currently have at least one dose of naloxone? (By this, we mean you possess 
#or own your own naloxone dose)
table(df_LA$NALOWN, useNA = "ifany") 

#NALUSEandorLOSE: Have you used and/or used your naloxone in the last 6 months?
df_LA$NALUSEandorLOSE <- ifelse((df_LA$NALUSED=="Yes" | df_LA$NALOSE=="Yes"), 1, 0)
table(df_LA$NALUSEandorLOSE, useNA = "ifany") 

#NALFILL: Got a refill of naloxone in the last 6 months
#After using or losing your naloxone, did you get a replacement or refill?
table(df_LA$NALFILL, useNA = "ifany")
```


Bar charts using counts for men (N=390).
```{r}
df_men <- subset(df, GENDER == "Male")

#NALEVER: Ever received naloxone 
#Have you ever received naloxone (including narcan, intranasal narcan, and/or autoinjector 
#of naloxone to use on yourself or other people?
table(df_men$NALEVER, useNA = "ifany") 

#NAL6MOS: Received naloxone in the last 6 months 
#Have you received naloxone in the last 6 months?
#table(df_men$NAL6MOS, useNA = "ifany")

#NAL6MOS.new: Received naloxone in the last 6 months (combined NALEVER and NAL6MOS to make NAL6MOS.new)
#Have you received naloxone in the last 6 months?
df_men$NAL6MOS.new <- ifelse(df_men$NALEVER=="Yes" & df_men$NAL6MOS=="Yes", 1, ifelse(df_men$NALEVER=="Yes" & df_men$NAL6MOS=="No", 0, ifelse(df_men$NALEVER=="No", 0, NA)))

table(df_men$NAL6MOS.new, useNA = "ifany")

#NALOWN: Own a dose of naloxone
#Do you currently have at least one dose of naloxone? (By this, we mean you possess 
#or own your own naloxone dose)
table(df_men$NALOWN, useNA = "ifany") 

#NALUSEandorLOSE: Have you used and/or used your naloxone in the last 6 months?
df_men$NALUSEandorLOSE <- ifelse((df_men$NALUSED=="Yes" | df_men$NALOSE=="Yes"), 1, 0)

table(df_men$NALUSEandorLOSE, useNA = "ifany") 

#NALFILL: Got a refill of naloxone in the last 6 months
#After using or losing your naloxone, did you get a replacement or refill?
table(df_men$NALFILL, useNA = "ifany")
```


Bar charts using counts for women (N=140).
```{r}
df_women <- subset(df, GENDER == "Female")

#NALEVER: Ever received naloxone 
#Have you ever received naloxone (including narcan, intranasal narcan, and/or autoinjector 
#of naloxone to use on yourself or other people?
table(df_women$NALEVER, useNA = "ifany") 

#NAL6MOS: Received naloxone in the last 6 months 
#Have you received naloxone in the last 6 months?
#table(df_women$NAL6MOS, useNA = "ifany")

#NAL6MOS.new: Received naloxone in the last 6 months (combined NALEVER and NAL6MOS to make NAL6MOS.new)
#Have you received naloxone in the last 6 months?
df_women$NAL6MOS.new <- ifelse(df_women$NALEVER=="Yes" & df_women$NAL6MOS=="Yes", 1, ifelse(df_women$NALEVER=="Yes" & df_women$NAL6MOS=="No", 0, ifelse(df_women$NALEVER=="No", 0, NA)))

table(df_women$NAL6MOS.new, useNA = "ifany")

#NALOWN: Own a dose of naloxone
#Do you currently have at least one dose of naloxone? (By this, we mean you possess 
#or own your own naloxone dose)
table(df_women$NALOWN, useNA = "ifany") 

#NALUSEandorLOSE: Have you used and/or used your naloxone in the last 6 months?
df_women$NALUSEandorLOSE <- ifelse((df_women$NALUSED=="Yes" | df_women$NALOSE=="Yes"), 1, 0)
table(df_women$NALUSEandorLOSE, useNA = "ifany") 

#NALFILL: Got a refill of naloxone in the last 6 months
#After using or losing your naloxone, did you get a replacement or refill?
table(df_women$NALFILL, useNA = "ifany")
```


Bar charts using counts for unhoused (N=361).
```{r}
df_unhoused <- subset(df, HOMELESS == "Yes")

#NALEVER: Ever received naloxone 
#Have you ever received naloxone (including narcan, intranasal narcan, and/or autoinjector 
#of naloxone to use on yourself or other people?
table(df_unhoused$NALEVER, useNA = "ifany") 

#NAL6MOS: Received naloxone in the last 6 months 
#Have you received naloxone in the last 6 months?
#table(df_unhoused$NAL6MOS, useNA = "ifany")

#NAL6MOS.new: Received naloxone in the last 6 months (combined NALEVER and NAL6MOS to make NAL6MOS.new)
#Have you received naloxone in the last 6 months?
df_unhoused$NAL6MOS.new <- ifelse(df_unhoused$NALEVER=="Yes" & df_unhoused$NAL6MOS=="Yes", 1, ifelse(df_unhoused$NALEVER=="Yes" & df_unhoused$NAL6MOS=="No", 0, ifelse(df_unhoused$NALEVER=="No", 0, NA)))

table(df_unhoused$NAL6MOS.new, useNA = "ifany")

#NALOWN: Own a dose of naloxone
#Do you currently have at least one dose of naloxone? (By this, we mean you possess 
#or own your own naloxone dose)
table(df_unhoused$NALOWN, useNA = "ifany") 

#NALUSEandorLOSE: Have you used and/or used your naloxone in the last 6 months?
df_unhoused$NALUSEandorLOSE <- ifelse((df_unhoused$NALUSED=="Yes" | df_unhoused$NALOSE=="Yes"), 1, 0)

table(df_unhoused$NALUSEandorLOSE, useNA = "ifany") 

#NALFILL: Got a refill of naloxone in the last 6 months
#After using or losing your naloxone, did you get a replacement or refill
table(df_unhoused$NALFILL, useNA = "ifany")
```

Bar charts using counts for housed (N=175).
```{r}
df_housed <- subset(df, HOMELESS == "No")

#NALEVER: Ever received naloxone 
#Have you ever received naloxone (including narcan, intranasal narcan, and/or autoinjector 
#of naloxone to use on yourself or other people?
table(df_housed$NALEVER, useNA = "ifany") 

#NAL6MOS: Received naloxone in the last 6 months 
#Have you received naloxone in the last 6 months?
#table(df_housed$NAL6MOS, useNA = "ifany")

#NAL6MOS.new: Received naloxone in the last 6 months (combined NALEVER and NAL6MOS to make NAL6MOS.new)
#Have you received naloxone in the last 6 months?
df_housed$NAL6MOS.new <- ifelse(df_housed$NALEVER=="Yes" & df_housed$NAL6MOS=="Yes", 1, ifelse(df_housed$NALEVER=="Yes" & df_housed$NAL6MOS=="No", 0, ifelse(df_housed$NALEVER=="No", 0, NA)))

table(df_housed$NAL6MOS.new, useNA = "ifany")

#NALOWN: Own a dose of naloxone
#Do you currently have at least one dose of naloxone? (By this, we mean you possess 
#or own your own naloxone dose)
table(df_housed$NALOWN, useNA = "ifany") 

#NALUSEandorLOSE: Have you used and/or used your naloxone in the last 6 months?
df_housed$NALUSEandorLOSE <- ifelse((df_housed$NALUSED=="Yes" | df_housed$NALOSE=="Yes"), 1, 0)

table(df_housed$NALUSEandorLOSE, useNA = "ifany") 

#NALFILL: Got a refill of naloxone in the last 6 months
#After using or losing your naloxone, did you get a replacement or refill?
table(df_housed$NALFILL, useNA = "ifany")
```

Bar charts using counts for witnessed OD in last 6 mos (N=265).
```{r}
df_witnessedOD <- subset(df, WOD6M == "Yes")

#NALEVER: Ever received naloxone 
#Have you ever received naloxone (including narcan, intranasal narcan, and/or autoinjector 
#of naloxone to use on yourself or other people?
table(df_witnessedOD$NALEVER, useNA = "ifany") 

#NAL6MOS: Received naloxone in the last 6 months 
#Have you received naloxone in the last 6 months?
#table(df_witnessedOD$NAL6MOS, useNA = "ifany")

#NAL6MOS.new: Received naloxone in the last 6 months (combined NALEVER and NAL6MOS to make NAL6MOS.new)
#Have you received naloxone in the last 6 months?
df_witnessedOD$NAL6MOS.new <- ifelse(df_witnessedOD$NALEVER=="Yes" & df_witnessedOD$NAL6MOS=="Yes", 1, ifelse(df_witnessedOD$NALEVER=="Yes" & df_witnessedOD$NAL6MOS=="No", 0, ifelse(df_witnessedOD$NALEVER=="No", 0, NA)))

table(df_witnessedOD$NAL6MOS.new, useNA = "ifany")

#NALOWN: Own a dose of naloxone
#Do you currently have at least one dose of naloxone? (By this, we mean you possess 
#or own your own naloxone dose)
table(df_witnessedOD$NALOWN, useNA = "ifany") 

#NALUSEandorLOSE: Have you used and/or used your naloxone in the last 6 months?
df_witnessedOD$NALUSEandorLOSE <- ifelse((df_witnessedOD$NALUSED=="Yes" | df_witnessedOD$NALOSE=="Yes"), 1, 0)

table(df_witnessedOD$NALUSEandorLOSE, useNA = "ifany") 

#NALFILL: Got a refill of naloxone in the last 6 months
#After using or losing your naloxone, did you get a replacement or refill?
table(df_witnessedOD$NALFILL, useNA = "ifany")
```


Bar charts using counts for haven't witnessed OD in last 6 mos (N=270).
```{r}
df_notwitnessedOD <- subset(df, WOD6M == "No")

#NALEVER: Ever received naloxone 
#Have you ever received naloxone (including narcan, intranasal narcan, and/or autoinjector 
#of naloxone to use on yourself or other people?
table(df_notwitnessedOD$NALEVER, useNA = "ifany") 

#NAL6MOS: Received naloxone in the last 6 months 
#Have you received naloxone in the last 6 months?
#table(df_notwitnessedOD$NAL6MOS, useNA = "ifany")

#NAL6MOS.new: Received naloxone in the last 6 months (combined NALEVER and NAL6MOS to make NAL6MOS.new)
#Have you received naloxone in the last 6 months?
df_notwitnessedOD$NAL6MOS.new <- ifelse(df_notwitnessedOD$NALEVER=="Yes" & df_notwitnessedOD$NAL6MOS=="Yes", 1, ifelse(df_notwitnessedOD$NALEVER=="Yes" & df_notwitnessedOD$NAL6MOS=="No", 0, ifelse(df_notwitnessedOD$NALEVER=="No", 0, NA)))

table(df_notwitnessedOD$NAL6MOS.new, useNA = "ifany")

#NALOWN: Own a dose of naloxone
#Do you currently have at least one dose of naloxone? (By this, we mean you possess 
#or own your own naloxone dose)
table(df_notwitnessedOD$NALOWN, useNA = "ifany") 

#NALUSEandorLOSE: Have you used and/or used your naloxone in the last 6 months?
df_notwitnessedOD$NALUSEandorLOSE <- ifelse((df_notwitnessedOD$NALUSED=="Yes" | df_notwitnessedOD$NALOSE=="Yes"), 1, 0)

table(df_notwitnessedOD$NALUSEandorLOSE, useNA = "ifany") 

#NALFILL: Got a refill of naloxone in the last 6 months
#After using or losing your naloxone, did you get a replacement or refill?
table(df_notwitnessedOD$NALFILL, useNA = "ifany")
```

Bar charts using counts for experienced OD in last 6 mos (N=85).
```{r}
df_experiencedOD <- subset(df, ODP6M == "Yes")

#NALEVER: Ever received naloxone 
#Have you ever received naloxone (including narcan, intranasal narcan, and/or autoinjector 
#of naloxone to use on yourself or other people?
table(df_experiencedOD$NALEVER, useNA = "ifany") 

#NAL6MOS: Received naloxone in the last 6 months 
#Have you received naloxone in the last 6 months?
#table(df_experiencedOD$NAL6MOS, useNA = "ifany")

#NAL6MOS.new: Received naloxone in the last 6 months (combined NALEVER and NAL6MOS to make NAL6MOS.new)
#Have you received naloxone in the last 6 months?
df_experiencedOD$NAL6MOS.new <- ifelse(df_experiencedOD$NALEVER=="Yes" & df_experiencedOD$NAL6MOS=="Yes", 1, ifelse(df_experiencedOD$NALEVER=="Yes" & df_experiencedOD$NAL6MOS=="No", 0, ifelse(df_experiencedOD$NALEVER=="No", 0, NA)))

table(df_experiencedOD$NAL6MOS.new, useNA = "ifany")

#NALOWN: Own a dose of naloxone
#Do you currently have at least one dose of naloxone? (By this, we mean you possess 
#or own your own naloxone dose)
table(df_experiencedOD$NALOWN, useNA = "ifany") 

#NALUSEandorLOSE: Have you used and/or used your naloxone in the last 6 months?
df_experiencedOD$NALUSEandorLOSE <- ifelse((df_experiencedOD$NALUSED=="Yes" | df_experiencedOD$NALOSE=="Yes"), 1, 0)

table(df_experiencedOD$NALUSEandorLOSE, useNA = "ifany") 

#NALFILL: Got a refill of naloxone in the last 6 months
#After using or losing your naloxone, did you get a replacement or refill?
table(df_experiencedOD$NALFILL, useNA = "ifany")
```

Bar charts using counts for haven't experienced OD in last 6 mos (N=449).
```{r}
df_notexperiencedOD <- subset(df, ODP6M == "No")

#NALEVER: Ever received naloxone 
#Have you ever received naloxone (including narcan, intranasal narcan, and/or autoinjector 
#of naloxone to use on yourself or other people?
table(df_notexperiencedOD$NALEVER, useNA = "ifany") 

#NAL6MOS: Received naloxone in the last 6 months 
#Have you received naloxone in the last 6 months?
#table(df_notexperiencedOD$NAL6MOS, useNA = "ifany")

#NAL6MOS.new: Received naloxone in the last 6 months (combined NALEVER and NAL6MOS to make NAL6MOS.new)
#Have you received naloxone in the last 6 months?
df_notexperiencedOD$NAL6MOS.new <- ifelse(df_notexperiencedOD$NALEVER=="Yes" & df_notexperiencedOD$NAL6MOS=="Yes", 1, ifelse(df_notexperiencedOD$NALEVER=="Yes" & df_notexperiencedOD$NAL6MOS=="No", 0, ifelse(df_notexperiencedOD$NALEVER=="No", 0, NA)))

table(df_notexperiencedOD$NAL6MOS.new, useNA = "ifany")

#NALOWN: Own a dose of naloxone
#Do you currently have at least one dose of naloxone? (By this, we mean you possess 
#or own your own naloxone dose)
table(df_notexperiencedOD$NALOWN, useNA = "ifany") 

#NALUSEandorLOSE: Have you used and/or used your naloxone in the last 6 months?
df_notexperiencedOD$NALUSEandorLOSE <- ifelse((df_notexperiencedOD$NALUSED=="Yes" | df_notexperiencedOD$NALOSE=="Yes"), 1, 0)

table(df_notexperiencedOD$NALUSEandorLOSE, useNA = "ifany") 

#NALFILL: Got a refill of naloxone in the last 6 months
#After using or losing your naloxone, did you get a replacement or refill?
table(df_notexperiencedOD$NALFILL, useNA = "ifany")
```


Descriptive variables for bivariate and multivariate analyses:
```{r}
#city
table(df$LOCALID, useNA = "ifany")

#gender (combine other and transgender into other so 3 cat variable)
df$GENDER <- df$GENDER %>% fct_collapse("Other" = c("Transgender","Other"))
table(df$GENDER, useNA = "ifany")

#age
table(df$AGE, useNA = "ifany")
table(df$agecat, useNA = "ifany") #(<30, 30 to 39, 40-49, 50 or more) MAY WANT TO RECUT THESE MYSELF

#race (recoded into fewer categories)
table(df$RACELG, useNA = "ifany")
df$RACE_cat <- df$RACELG %>% fct_collapse("Other" = c("Native American","Asian/Pacific Islander", "Mixed Race/Other"))

df$RACE_cat <- droplevels(df$RACE_cat, exclude=c("Don't know", "Refused"))
table(df$RACE_cat, useNA = "ifany")

#education (High school education or more)
table(df$ED, useNA = "ifany")

#homelessness (Consider Self Homeless)
table(df$HOMELESS, useNA = "ifany")

#incarceration (Any jail in the last 6 months)
table(df$JAIL, useNA = "ifany")

#users of certain non-injection drugs

table(df$CRKNINJ, useNA = "ifany") #non-injection crack in last 30 days
table(df$CCNINJ, useNA = "ifany") #non-injection powder cocaine in last 30 days
table(df$MTNINJ, useNA = "ifany") #non-injection methamphetamine in last 30 days
table(df$STNINJ, useNA = "ifany") #non-injection prescription stimulant use in last 30 days
table(df$HRNINJ, useNA = "ifany") #non-injection heroin last 30 days
table(df$OPNINJ, useNA = "ifany") #non-injection NMPO use in last 30 days

#users of certain injection drugs
table(df$CRKINJ, useNA = "ifany") #crack injection in last 30 days
table(df$CCINJ, useNA = "ifany") #powder cocaine injection in last 30 days
table(df$MTINJ, useNA = "ifany") #meth injection in last 30 days
table(df$STINJ, useNA = "ifany") #prescription stimulant injection in last 30 days
table(df$HRINJ, useNA = "ifany") #heroin injection in last 30 days
table(df$OPINJ, useNA = "ifany") #NMPO injection in last 30 days

#any stimulant use in last 30 days (injection and/or non-injection composite)
df$ANYSTIMUSE <- ifelse(df$CRKNINJ=="Yes" | df$CCNINJ=="Yes" | df$MTNINJ=="Yes" | df$STNINJ=="Yes" | df$CRKINJ=="Yes" | df$CCINJ=="Yes" | df$MTINJ=="Yes" | df$STINJ=="Yes", 1, ifelse(df$CRKNINJ=="No" &df$CCNINJ=="No" & df$MTNINJ=="No" & df$STNINJ=="No" & df$CRKINJ=="No" &  df$CCINJ=="No" & df$MTINJ=="No" & df$STINJ=="No", 0, NA))

df$ANYSTIMUSE <- as.factor(df$ANYSTIMUSE)
table(df$ANYSTIMUSE, useNA = "ifany")

#any opioid use in last 30 days (injection and/or non-injection composite)
df$ANYOPIOIDUSE <- ifelse(df$HRNINJ=="Yes" |df$OPNINJ=="Yes" | df$HRINJ=="Yes" | df$OPINJ=="Yes", 1, ifelse(df$HRNINJ=="No" & df$OPNINJ=="No" & df$HRINJ=="No" & df$OPINJ=="No", 0, NA))

df$ANYOPIOIDUSE <- as.factor(df$ANYOPIOIDUSE)
table(df$ANYOPIOIDUSE, useNA = "ifany")

#overdose witnessed (witnessed an overdose in the last 6 months)
table(df$WOD6M, useNA = "ifany")

#personal overdose history (Overdosed in the last 6 months)
table(df$ODP6M, useNA = "ifany")
```

Overall Table 1 not stratified by any outcome.
```{r}
# Identify the variables of interest
myVars <- c("LOCALID", "GENDER","agecat","RACE_cat", "ED","HOMELESS", "JAIL", "ANYSTIMUSE", "ANYOPIOIDUSE", "WOD6M", "ODP6M") 

# Specify which of the variables are categorical
catVars <- c("LOCALID", "GENDER", "agecat", "RACE_cat", "ED","HOMELESS", "JAIL", "ANYSTIMUSE", "ANYOPIOIDUSE", "WOD6M", "ODP6M") 

# Create an overall table 1
#REMINDER THAT TABLE1 PACKAGE DOES WEIRD STUFF WITH MISSING, SO CHECK N (PERCENTAGE) WITH CROSSTABS 

table1.overall <- CreateTableOne(vars= myVars, 
                                 data= df, 
                                 factorVars = catVars)

print(table1.overall, showAllLevels = TRUE, missing = FALSE)
```


Table 1 for correlates of receiving naloxone in the last 6 months (NAL6MOS.new)
```{r}
# Create a table 1 stratified by receiving naloxone in the last 6 mos (1 = ever received in last 6 mos, 0 = never received in last 6 mos) 
##REMINDER THAT TABLE1 PACKAGE DOES WEIRD STUFF WITH MISSING, SO CHECK N (PERCENTAGE) WITH CROSSTABS 

#check column percentages of bivariates. this is because prop.table will show missing percentages whereas tableone package doesn't include the missing data when calculating column percents.
#table(df$X, df$NAL6MOS.new, useNA = "ifany")
#round(prop.table(table(df$X, df$NAL6MOS.new, useNA = "ifany"),2),3)

table1byNAL6MOS.new <- CreateTableOne(vars=myVars, 
                                   data=df, 
                                   factorVars = catVars,
                                   strata="NAL6MOS.new")

print(table1byNAL6MOS.new, showAllLevels = TRUE, test=TRUE, missing = FALSE)
```


NOTE: NAL6MOS.new: All bivariate models converge using log-binomial model, but multivariate log-binomial model will not converge, so will use modified poisson instead.
```{r}
#glm(NAL6MOS.new ~ factor(LOCALID), data=df, family=binomial(log))
#glm(NAL6MOS.new ~ factor(GENDER), data=df, family=binomial(log))
#glm(NAL6MOS.new ~ factor(agecat), data=df, family=binomial(log))
#glm(NAL6MOS.new ~ factor(RACE_cat), data=df, family=binomial(log))
#glm(NAL6MOS.new ~ factor(ED), data=df, family=binomial(log))
#glm(NAL6MOS.new ~ factor(HOMELESS), data=df, family=binomial(log))
#glm(NAL6MOS.new ~ factor(JAIL), data=df, family=binomial(log))
#glm(NAL6MOS.new ~ factor(ANYSTIMUSE), data=df, family=binomial(log))
#glm(NAL6MOS.new ~ factor(ANYOPIOIDUSE), data=df, family=binomial(log))
#glm(NAL6MOS.new ~ factor(WOD6M), data=df, family=binomial(log))
#glm(NAL6MOS.new ~ factor(ODP6M), data=df, family=binomial(log))

#glm(NAL6MOS.new ~ factor(LOCALID) + factor(GENDER) + factor(agecat) + factor(ED) + factor(HOMELESS) + factor(JAIL) + factor(ANYSTIMUSE) + factor(ANYOPIOIDUSE) + factor(WOD6M) + factor(ODP6M), data=df, family=binomial(log))
```


NAL6MOS.new: Bivariate and multivariate models for receiving naloxone in the last 6 months using modified Poisson regression with robust standard errors. (CITE ZOU'S MODIFIED POISSON 2004 paper)
```{r}
#use geepack because modified poisson is picky
require(geepack)

#subset the data with complete observations because geepack is picky (N=527)
df.modpoiss <- subset(df, select=c(SUBJECT, NAL6MOS.new, LOCALID, GENDER, agecat, RACE_cat, ED, HOMELESS, JAIL, ANYSTIMUSE, ANYOPIOIDUSE, WOD6M, ODP6M))
df.modpoiss <- na.omit(df.modpoiss)

#CITY 
localIDbynal6mos.modpoiss <- geeglm(formula=NAL6MOS.new ~ factor(LOCALID), data=df.modpoiss, id=SUBJECT, family=poisson(link="log"), corstr = "exchangeable")
summary(localIDbynal6mos.modpoiss)
exp(coef(localIDbynal6mos.modpoiss))

  #95% CI for city
  localIDbynal6mos.modpoiss.RR.coefci.adj <- cbind(localIDbynal6mos.modpoiss$coefficients, confint.default(localIDbynal6mos.modpoiss))
  localIDbynal6mos.modpoiss.RR.expci.adj <- exp(localIDbynal6mos.modpoiss.RR.coefci.adj)
  localIDbynal6mos.modpoiss.RR.expci.adj

  #rounded to two decimal places
  round(localIDbynal6mos.modpoiss.RR.expci.adj, 2)

  #GENDER
genderbynal6mos.modpoiss <- geeglm(formula=NAL6MOS.new ~ factor(GENDER), data=df.modpoiss, id=SUBJECT, family=poisson(link="log"), corstr = "exchangeable")
summary(genderbynal6mos.modpoiss)
exp(coef(genderbynal6mos.modpoiss))

#95% CI for gender
  genderbynal6mos.modpoiss.RR.coefci.adj <- cbind(genderbynal6mos.modpoiss$coefficients, confint.default(genderbynal6mos.modpoiss))
  genderbynal6mos.modpoiss.RR.expci.adj <- exp(genderbynal6mos.modpoiss.RR.coefci.adj)
  genderbynal6mos.modpoiss.RR.expci.adj

    #rounded to two decimal places
  round(genderbynal6mos.modpoiss.RR.expci.adj, 2)

  #agecat
agecatbynal6mos.modpoiss <- geeglm(formula=NAL6MOS.new ~ factor(agecat), data=df.modpoiss, id=SUBJECT, family=poisson(link="log"), corstr = "exchangeable")
summary(agecatbynal6mos.modpoiss)
exp(coef(agecatbynal6mos.modpoiss))

#95% CI for agecat
  agecatbynal6mos.modpoiss.RR.coefci.adj <- cbind(agecatbynal6mos.modpoiss$coefficients, confint.default(agecatbynal6mos.modpoiss))
  agecatbynal6mos.modpoiss.RR.expci.adj <- exp(agecatbynal6mos.modpoiss.RR.coefci.adj)
  agecatbynal6mos.modpoiss.RR.expci.adj
  
      #rounded to two decimal places
  round(agecatbynal6mos.modpoiss.RR.expci.adj, 2)
  
#race_cat
racecatbynal6mos.modpoiss <- geeglm(formula=NAL6MOS.new ~ factor(RACE_cat), data=df.modpoiss, id=SUBJECT, family=poisson(link="log"), corstr = "exchangeable")
summary(racecatbynal6mos.modpoiss)
exp(coef(racecatbynal6mos.modpoiss))

#95% CI for racecat
  racecatbynal6mos.modpoiss.RR.coefci.adj <- cbind(racecatbynal6mos.modpoiss$coefficients, confint.default(racecatbynal6mos.modpoiss))
  racecatbynal6mos.modpoiss.RR.expci.adj <- exp(racecatbynal6mos.modpoiss.RR.coefci.adj)
  racecatbynal6mos.modpoiss.RR.expci.adj

        #rounded to two decimal places
  round(racecatbynal6mos.modpoiss.RR.expci.adj, 2)
   
#ED
edbynal6mos.modpoiss <- geeglm(formula=NAL6MOS.new ~ factor(ED), data=df.modpoiss, id=SUBJECT, family=poisson(link="log"), corstr = "exchangeable")
summary(edbynal6mos.modpoiss)
exp(coef(edbynal6mos.modpoiss))

#95% CI for ed
  edbynal6mos.modpoiss.RR.coefci.adj <- cbind(edbynal6mos.modpoiss$coefficients, confint.default(edbynal6mos.modpoiss))
  edbynal6mos.modpoiss.RR.expci.adj <- exp(edbynal6mos.modpoiss.RR.coefci.adj)
  edbynal6mos.modpoiss.RR.expci.adj

        #rounded to two decimal places
  round(edbynal6mos.modpoiss.RR.expci.adj, 2)
  
#HOMELESS
homelessbynal6mos.modpoiss <- geeglm(formula=NAL6MOS.new ~ factor(HOMELESS), data=df.modpoiss, id=SUBJECT, family=poisson(link="log"), corstr = "exchangeable")
summary(homelessbynal6mos.modpoiss)
exp(coef(homelessbynal6mos.modpoiss))

#95% CI for homeless
  homelessbynal6mos.modpoiss.RR.coefci.adj <- cbind(homelessbynal6mos.modpoiss$coefficients, confint.default(homelessbynal6mos.modpoiss))
  homelessbynal6mos.modpoiss.RR.expci.adj <- exp(homelessbynal6mos.modpoiss.RR.coefci.adj)
  homelessbynal6mos.modpoiss.RR.expci.adj

        #rounded to two decimal places
  round(homelessbynal6mos.modpoiss.RR.expci.adj, 2)
  
#JAIL
jailbynal6mos.modpoiss <- geeglm(formula=NAL6MOS.new ~ factor(JAIL), data=df.modpoiss, id=SUBJECT, family=poisson(link="log"), corstr = "exchangeable")
summary(jailbynal6mos.modpoiss)
exp(coef(jailbynal6mos.modpoiss))

#95% CI for jail
  jailbynal6mos.modpoiss.RR.coefci.adj <- cbind(jailbynal6mos.modpoiss$coefficients, confint.default(jailbynal6mos.modpoiss))
  jailbynal6mos.modpoiss.RR.expci.adj <- exp(jailbynal6mos.modpoiss.RR.coefci.adj)
  jailbynal6mos.modpoiss.RR.expci.adj

        #rounded to two decimal places
  round(jailbynal6mos.modpoiss.RR.expci.adj, 2)
  
#ANYSTIMUSE
ANYSTIMUSEbynal6mos.modpoiss <- geeglm(formula=NAL6MOS.new ~ factor(ANYSTIMUSE), data=df.modpoiss, id=SUBJECT, family=poisson(link="log"), corstr = "exchangeable")
summary(ANYSTIMUSEbynal6mos.modpoiss)
exp(coef(ANYSTIMUSEbynal6mos.modpoiss))

#95% CI for ANYSTIMUSE
  ANYSTIMUSEbynal6mos.modpoiss.RR.coefci.adj <- cbind(ANYSTIMUSEbynal6mos.modpoiss$coefficients, confint.default(ANYSTIMUSEbynal6mos.modpoiss))
  ANYSTIMUSEbynal6mos.modpoiss.RR.expci.adj <- exp(ANYSTIMUSEbynal6mos.modpoiss.RR.coefci.adj)
  ANYSTIMUSEbynal6mos.modpoiss.RR.expci.adj

        #rounded to two decimal places
  round(ANYSTIMUSEbynal6mos.modpoiss.RR.expci.adj, 2)  

#ANYOPIOIDUSE
ANYOPIOIDUSEbynal6mos.modpoiss <- geeglm(formula=NAL6MOS.new ~ factor(ANYOPIOIDUSE), data=df.modpoiss, id=SUBJECT, family=poisson(link="log"), corstr = "exchangeable")
summary(ANYOPIOIDUSEbynal6mos.modpoiss)
exp(coef(ANYOPIOIDUSEbynal6mos.modpoiss))

#95% CI for ANYOPIOIDUSE
  ANYOPIOIDUSEbynal6mos.modpoiss.RR.coefci.adj <- cbind(ANYOPIOIDUSEbynal6mos.modpoiss$coefficients, confint.default(ANYOPIOIDUSEbynal6mos.modpoiss))
  ANYOPIOIDUSEbynal6mos.modpoiss.RR.expci.adj <- exp(ANYOPIOIDUSEbynal6mos.modpoiss.RR.coefci.adj)
  ANYOPIOIDUSEbynal6mos.modpoiss.RR.expci.adj
       
   #rounded to two decimal places
  round(ANYOPIOIDUSEbynal6mos.modpoiss.RR.expci.adj, 2)  

  #WOD6M
WOD6Mbynal6mos.modpoiss <- geeglm(formula=NAL6MOS.new ~ factor(WOD6M), data=df.modpoiss, id=SUBJECT, family=poisson(link="log"), corstr = "exchangeable")
summary(WOD6Mbynal6mos.modpoiss)
exp(coef(WOD6Mbynal6mos.modpoiss))

#95% CI for WOD6M
  WOD6Mbynal6mos.modpoiss.RR.coefci.adj <- cbind(WOD6Mbynal6mos.modpoiss$coefficients, confint.default(WOD6Mbynal6mos.modpoiss))
  WOD6Mbynal6mos.modpoiss.RR.expci.adj <- exp(WOD6Mbynal6mos.modpoiss.RR.coefci.adj)
  WOD6Mbynal6mos.modpoiss.RR.expci.adj

     #rounded to two decimal places
  round(WOD6Mbynal6mos.modpoiss.RR.expci.adj, 2)  
  
#ODP6M
ODP6Mbynal6mos.modpoiss <- geeglm(formula=NAL6MOS.new ~ factor(ODP6M), data=df.modpoiss, id=SUBJECT, family=poisson(link="log"), corstr = "exchangeable")
summary(ODP6Mbynal6mos.modpoiss)
exp(coef(ODP6Mbynal6mos.modpoiss))

#95% CI for ODP6M
  ODP6Mbynal6mos.modpoiss.RR.coefci.adj <- cbind(ODP6Mbynal6mos.modpoiss$coefficients, confint.default(ODP6Mbynal6mos.modpoiss))
  ODP6Mbynal6mos.modpoiss.RR.expci.adj <- exp(ODP6Mbynal6mos.modpoiss.RR.coefci.adj)
  ODP6Mbynal6mos.modpoiss.RR.expci.adj

       #rounded to two decimal places
  round(ODP6Mbynal6mos.modpoiss.RR.expci.adj, 2) 
  
####DIFFERENT APPROACHES FOR MULTIVARIATE MODELS

####FULL MULTIVARIATE MODIFIED POISSON MODEL WITH EVERY COVARIATE INCLUDED
fitnal6mos.modpoiss  <- geeglm(formula=NAL6MOS.new ~ factor(LOCALID) + factor(GENDER) + factor(agecat) + factor(RACE_cat) + factor(ED) + factor(HOMELESS) + factor(JAIL) + factor(ANYSTIMUSE) + factor(ANYOPIOIDUSE) + factor(WOD6M) + factor(ODP6M), data=df.modpoiss, id=SUBJECT, family=poisson(link="log"), corstr = "exchangeable")

summary(fitnal6mos.modpoiss)

#extract the coefficients and confidence intervals, exponentiate to get RR and 95% CI (using confint.default)
fitnal6mos.RR.coefci.adj <- cbind(fitnal6mos.modpoiss$coefficients, confint.default(fitnal6mos.modpoiss))
fitnal6mos.RR.expci.adj <- exp(fitnal6mos.RR.coefci.adj)
fitnal6mos.RR.expci.adj

###ADJUSTED MULTIVARIATE MODIFIED POISSON INCLUDING ONLY THOSE SIGNIFICANT AT LESS THAN 0.05 or 0.2 (SO ONLY TAKE OUT GENDER). THE FINDINGS ARE EXACTLY THE SAME
fitnal6mos.modpoiss.approach1  <- geeglm(formula=NAL6MOS.new ~ factor(LOCALID) + factor(agecat) + factor(RACE_cat) + factor(ED) + factor(HOMELESS) + factor(JAIL) + factor(ANYSTIMUSE) + factor(ANYOPIOIDUSE) + factor(WOD6M) + factor(ODP6M), data=df.modpoiss, id=SUBJECT, family=poisson(link="log"), corstr = "exchangeable")

summary(fitnal6mos.modpoiss.approach1)
```

NAL6MOS.new: If I end up needing to calculate the 95% CI for RRs by hand instead.
```{r}
#getting coefficients and standard errors using regular glm and the sandwich estimator
#fitNAL6MOS.new <- glm(NAL6MOS.new ~ factor(LOCALID) + factor(GENDER) + factor(agecat) + factor(ED) + factor(HOMELESS) + factor(JAIL) + factor(ANYSTIMUSE) + factor(ANYOPIOIDUSE) + factor(WOD6M) + factor(ODP6M), data=df, family=binomial(log))

#library(sandwich) # to get robust estimators
#library(lmtest) # to test coefficients
#coeftest(fitNAL6MOS.new, vcov = sandwich)
#exp(coef(fitNAL6MOS.new)) #to get RR

## CIs 
#localID
#exp(beta + qnorm(0.05 / 2) * SE) # lower 95% CI
#exp(beta  + qnorm(1 - 0.05 / 2) * SE) #upper 95% CI
```


NALOWN: Table 1 for correlates of currently owning naloxone [NALOWN].
Of the 265 people who have received naloxone in the past 6 mos, 188 currently own it and 76 don't currently own it.
```{r}
#subset the data to those who have received naloxone in the last 6 mos
df_nal6mos <- subset(df, NAL6MOS.new == 1) #N = 265 who have received naloxone in the last 6 mos

#checking frequencies are correct
table(df_nal6mos$NALOWN, useNA = "ifany")

#Create a table 1 not stratified by any outcome variable, just for this subset of N = 265 PWID who received naloxone in the last 6mos
table1.subset.receivednal6mos <- CreateTableOne(vars= myVars, 
                                 data= df_nal6mos, 
                                 factorVars = catVars)

print(table1.subset.receivednal6mos, showAllLevels = TRUE, missing = FALSE)


# Create a table 1 stratified by currently owning naloxone
table1byNALOWN <- CreateTableOne(vars=myVars, 
                                   data=df_nal6mos, 
                                   factorVars = catVars,
                                   strata="NALOWN")

print(table1byNALOWN, showAllLevels = TRUE, missing = FALSE)


#FOR UNIVARIATES: check column percentages of univariates. this is because prop.table will show missing percentages whereas tableone package doesn't include the missing data when calculating column percents.
#table(df_nal6mos$X, useNA = "ifany")
#round(prop.table(table(df_nal6mos$X, useNA = "ifany")),3)


#FOR BIVARIATES: check column percentages of bivariates. this is because prop.table will show missing percentages whereas tableone package doesn't include the missing data when calculating column percents.
#table(df_nal6mos$X, df_nal6mos$NALOWN, useNA = "ifany")
#round(prop.table(table(df_nal6mos$X, df_nal6mos$NALOWN, useNA = "ifany"),2),3)
```

NALOWN: Bivariate and multivariate models for currently owning naloxone among those who report receiving naloxone in the last 6 months using modified Poisson regression with robust standard errors. (CITE ZOU'S MODIFIED POISSON 2004 paper)
```{r}
#require geepack because modified poisson is picky
require(geepack)

#subset the data with complete observations because geepack is picky (N= 259)
df.modpoiss.nalown <- subset(df_nal6mos, select=c(SUBJECT, NALOWN, LOCALID, GENDER, agecat, RACE_cat, ED, HOMELESS, JAIL, ANYSTIMUSE, ANYOPIOIDUSE, WOD6M, ODP6M))
df.modpoiss.nalown <- na.omit(df.modpoiss.nalown)

#recode NALOWN as binary numeric since factor isn't working
df.modpoiss.nalown$NALOWN.binary<-ifelse(df.modpoiss.nalown$NALOWN=='Yes', 1,0)

#LOCALID
localIDbynalown.modpoiss <- geeglm(formula=NALOWN.binary ~ factor(LOCALID), data=df.modpoiss.nalown, id=SUBJECT, family=poisson(link="log"), corstr = "exchangeable")
summary(localIDbynalown.modpoiss)
exp(coef(localIDbynalown.modpoiss))

#95% CI for localID
localIDbynalown.modpoiss.RR.coefci.adj <- cbind(localIDbynalown.modpoiss$coefficients, confint.default(localIDbynalown.modpoiss))
localIDbynalown.modpoiss.RR.expci.adj <- exp(localIDbynalown.modpoiss.RR.coefci.adj)
localIDbynalown.modpoiss.RR.expci.adj

       #rounded to two decimal places
  round(localIDbynalown.modpoiss.RR.expci.adj, 2) 
  
#GENDER
genderbynalown.modpoiss <- geeglm(formula=NALOWN.binary ~ factor(GENDER), data=df.modpoiss.nalown, id=SUBJECT, family=poisson(link="log"), corstr = "exchangeable")
summary(genderbynalown.modpoiss)
exp(coef(genderbynalown.modpoiss))

#95% CI for gender
genderbynalown.modpoiss.RR.coefci.adj <- cbind(genderbynalown.modpoiss$coefficients, confint.default(genderbynalown.modpoiss))
genderbynalown.modpoiss.RR.expci.adj <- exp(genderbynalown.modpoiss.RR.coefci.adj)
genderbynalown.modpoiss.RR.expci.adj

       #rounded to two decimal places
  round(genderbynalown.modpoiss.RR.expci.adj, 2) 

#agecat
agecatbynalown.modpoiss <- geeglm(formula=NALOWN.binary ~ factor(agecat), data=df.modpoiss.nalown, id=SUBJECT, family=poisson(link="log"), corstr = "exchangeable")
summary(agecatbynalown.modpoiss)
exp(coef(agecatbynalown.modpoiss))

#95% CI for agecat
agecatbynalown.modpoiss.RR.coefci.adj <- cbind(agecatbynalown.modpoiss$coefficients, confint.default(agecatbynalown.modpoiss))
agecatbynalown.modpoiss.RR.expci.adj <- exp(agecatbynalown.modpoiss.RR.coefci.adj)
agecatbynalown.modpoiss.RR.expci.adj
   
#rounded to two decimal places
  round(agecatbynalown.modpoiss.RR.expci.adj, 2) 

  #racecat
racecatbynalown.modpoiss <- geeglm(formula=NALOWN.binary ~ factor(RACE_cat), data=df.modpoiss.nalown, id=SUBJECT, family=poisson(link="log"), corstr = "exchangeable")
summary(racecatbynalown.modpoiss)
exp(coef(racecatbynalown.modpoiss))

#95% CI for racecat
racecatbynalown.modpoiss.RR.coefci.adj <- cbind(racecatbynalown.modpoiss$coefficients, confint.default(racecatbynalown.modpoiss))
racecatbynalown.modpoiss.RR.expci.adj <- exp(racecatbynalown.modpoiss.RR.coefci.adj)
racecatbynalown.modpoiss.RR.expci.adj

#rounded to two decimal places
  round(racecatbynalown.modpoiss.RR.expci.adj, 2) 
  
#ED
edbynalown.modpoiss <- geeglm(formula=NALOWN.binary ~ factor(ED), data=df.modpoiss.nalown, id=SUBJECT, family=poisson(link="log"), corstr = "exchangeable")
summary(edbynalown.modpoiss)
exp(coef(edbynalown.modpoiss))

#95% CI for ed
edbynalown.modpoiss.RR.coefci.adj <- cbind(edbynalown.modpoiss$coefficients, confint.default(edbynalown.modpoiss))
edbynalown.modpoiss.RR.expci.adj <- exp(edbynalown.modpoiss.RR.coefci.adj)
edbynalown.modpoiss.RR.expci.adj

#rounded to two decimal places
  round(edbynalown.modpoiss.RR.expci.adj, 2) 
  
#HOMELESS
homelessbynalown.modpoiss <- geeglm(formula=NALOWN.binary ~ factor(HOMELESS), data=df.modpoiss.nalown, id=SUBJECT, family=poisson(link="log"), corstr = "exchangeable")
summary(homelessbynalown.modpoiss)
exp(coef(homelessbynalown.modpoiss))

#95% CI for homeless
homelessbynalown.modpoiss.RR.coefci.adj <- cbind(homelessbynalown.modpoiss$coefficients, confint.default(homelessbynalown.modpoiss))
homelessbynalown.modpoiss.RR.expci.adj <- exp(homelessbynalown.modpoiss.RR.coefci.adj)
homelessbynalown.modpoiss.RR.expci.adj

#rounded to two decimal places
  round(homelessbynalown.modpoiss.RR.expci.adj, 2) 

#JAIL
jailbynalown.modpoiss <- geeglm(formula=NALOWN.binary ~ factor(JAIL), data=df.modpoiss.nalown, id=SUBJECT, family=poisson(link="log"), corstr = "exchangeable")
summary(jailbynalown.modpoiss)
exp(coef(jailbynalown.modpoiss))

#95% CI for jail
jailbynalown.modpoiss.RR.coefci.adj <- cbind(jailbynalown.modpoiss$coefficients, confint.default(jailbynalown.modpoiss))
jailbynalown.modpoiss.RR.expci.adj <- exp(jailbynalown.modpoiss.RR.coefci.adj)
jailbynalown.modpoiss.RR.expci.adj

#rounded to two decimal places
  round(jailbynalown.modpoiss.RR.expci.adj, 2) 

#ANYSTIMUSE
ANYSTIMUSEbynalown.modpoiss <- geeglm(formula=NALOWN.binary ~ factor(ANYSTIMUSE), data=df.modpoiss.nalown, id=SUBJECT, family=poisson(link="log"), corstr = "exchangeable")
summary(ANYSTIMUSEbynalown.modpoiss)
exp(coef(ANYSTIMUSEbynalown.modpoiss))

#95% CI for ANYSTIMUSE
ANYSTIMUSEbynalown.modpoiss.RR.coefci.adj <- cbind(ANYSTIMUSEbynalown.modpoiss$coefficients, confint.default(ANYSTIMUSEbynalown.modpoiss))
ANYSTIMUSEbynalown.modpoiss.RR.expci.adj <- exp(ANYSTIMUSEbynalown.modpoiss.RR.coefci.adj)
ANYSTIMUSEbynalown.modpoiss.RR.expci.adj

#rounded to two decimal places
  round(ANYSTIMUSEbynalown.modpoiss.RR.expci.adj, 2) 
  
#ANYOPIOIDUSE
ANYOPIOIDUSEbynalown.modpoiss <- geeglm(formula=NALOWN.binary ~ factor(ANYOPIOIDUSE), data=df.modpoiss.nalown, id=SUBJECT, family=poisson(link="log"), corstr = "exchangeable")
summary(ANYOPIOIDUSEbynalown.modpoiss)
exp(coef(ANYOPIOIDUSEbynalown.modpoiss))

#95% CI for ANYOPIOIDUSE
ANYOPIOIDUSEbynalown.modpoiss.RR.coefci.adj <- cbind(ANYOPIOIDUSEbynalown.modpoiss$coefficients, confint.default(ANYOPIOIDUSEbynalown.modpoiss))
ANYOPIOIDUSEbynalown.modpoiss.RR.expci.adj <- exp(ANYOPIOIDUSEbynalown.modpoiss.RR.coefci.adj)
ANYOPIOIDUSEbynalown.modpoiss.RR.expci.adj

#rounded to two decimal places
  round(ANYOPIOIDUSEbynalown.modpoiss.RR.expci.adj, 2) 

#WOD6M
WOD6Mbynalown.modpoiss <- geeglm(formula=NALOWN.binary ~ factor(WOD6M), data=df.modpoiss.nalown, id=SUBJECT, family=poisson(link="log"), corstr = "exchangeable")
summary(WOD6Mbynalown.modpoiss)
exp(coef(WOD6Mbynalown.modpoiss))

#95% CI for WOD6M
WOD6Mbynalown.modpoiss.RR.coefci.adj <- cbind(WOD6Mbynalown.modpoiss$coefficients, confint.default(WOD6Mbynalown.modpoiss))
WOD6Mbynalown.modpoiss.RR.expci.adj <- exp(WOD6Mbynalown.modpoiss.RR.coefci.adj)
WOD6Mbynalown.modpoiss.RR.expci.adj

#rounded to two decimal places
  round(WOD6Mbynalown.modpoiss.RR.expci.adj, 2) 
  
#ODP6M
ODP6Mbynalown.modpoiss <- geeglm(formula=NALOWN.binary ~ factor(ODP6M), data=df.modpoiss.nalown, id=SUBJECT, family=poisson(link="log"), corstr = "exchangeable")
summary(ODP6Mbynalown.modpoiss)
exp(coef(ODP6Mbynalown.modpoiss))

#95% CI for ODP6M
ODP6Mbynalown.modpoiss.RR.coefci.adj <- cbind(ODP6Mbynalown.modpoiss$coefficients, confint.default(ODP6Mbynalown.modpoiss))
ODP6Mbynalown.modpoiss.RR.expci.adj <- exp(ODP6Mbynalown.modpoiss.RR.coefci.adj)
ODP6Mbynalown.modpoiss.RR.expci.adj

#rounded to two decimal places
  round(ODP6Mbynalown.modpoiss.RR.expci.adj, 2) 

#MULTIVARIATE MODELS USING DIFFERENT APPROACHES
#full multivariate model using every covariate regardless of significance
fitnalown.modpoiss <- geeglm(formula=NALOWN.binary ~ factor(LOCALID) + factor(GENDER) + factor(agecat) + factor(RACE_cat) + factor(ED) + factor(HOMELESS) + factor(JAIL) + factor(ANYSTIMUSE) + factor(ANYOPIOIDUSE) + factor(WOD6M) + factor(ODP6M), data=df.modpoiss.nalown, id=SUBJECT, family=poisson(link="log"), corstr = "exchangeable")
summary(fitnalown.modpoiss)
exp(coef(fitnalown.modpoiss))

#extract the coefficients and confidence intervals, exponentiate to get RR and 95% CI (using confint.default)
fitnalown.RR.coefci.adj <- cbind(fitnalown.modpoiss$coefficients, confint.default(fitnalown.modpoiss))
fitnalown.RR.expci.adj <- exp(fitnalown.RR.coefci.adj)
fitnalown.RR.expci.adj

###ADJUSTED MULTIVARIATE MODIFIED POISSON INCLUDING ONLY THOSE SIGNIFICANT AT LESS THAN 0.2 (not using p < .05 because then the model is only housing and jail)
fitnalown.modpoiss.approach1 <- geeglm(formula=NALOWN.binary ~ factor(LOCALID) + factor(agecat) + factor(ED) + factor(HOMELESS) + factor(JAIL)  + factor(ANYOPIOIDUSE), data=df.modpoiss.nalown, id=SUBJECT, family=poisson(link="log"), corstr = "exchangeable")

summary(fitnalown.modpoiss.approach1)

```


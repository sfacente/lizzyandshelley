---
title: "242 Final Project"
author: "Lizzy Kinnard and Shelley Facente"
date: "November 13, 2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#open packages
library(here)
library(foreign)
library(labelled)
library(dplyr)
library(reshape2)
library(lme4)
library(MASS)
```

```{r dataload, include=FALSE}
#set working directory
setwd("~/Desktop/lizzyandshelley/Dataset") #LIZZY
#setwd("~/GitHub/lizzyandshelley/Dataset")  #SHELLEY

#load the data
df <- read.spss("Ricky.SAV", use.value.labels = TRUE, to.data.frame=TRUE)

#get variable labels
attr(df, "variable.labels")
df.labels <- as.data.frame(attr(df, "variable.labels"))
QDSlabels <- data.frame(rownames(df.labels))
df.labels <- cbind(QDSlabels, df.labels)
names(df.labels) <- c("VAR_ID", "description")
rm(QDSlabels)

#clean up data types
df$MOSHOME <- as.numeric(df$MOSHOME)
df$MOSHOME1 <- as.numeric(df$MOSHOME1)
df$MOSHOME[is.na(df$MOSHOME)] <- 0
df$MOSHOME1[is.na(df$MOSHOME1)] <- 0
df$AGE <- as.numeric(df$AGE)
df$Rshare1 <- factor(df$Rshare1)

#remove subjects with NA for key variables from the dataset
df <- subset(df, SUBJECT!=4394) 
df <- subset(df, SUBJECT!=4457) 
df <- subset(df, SUBJECT!=5267) 

#reweight sample to address LTFU
gFU1 <- glm(FU1 ~ Rshare + PUBINJ + HOMELESS + MOSHOME + IJWOTH + GENDER + AGE + RACELG, family = "binomial", data = df, na.action = na.omit) 
gFU2 <- glm(FU2 ~ FU1 + Rshare + PUBINJ + HOMELESS + MOSHOME + IJWOTH + GENDER + AGE + RACELG, family = "binomial", data = df, na.action = na.omit) 
df$pFU1 <- predict(gFU1, type = "response")
df$pFU2 <- predict(gFU2, type = "response")
df$wFU1 <- (df$FU1 == "Yes") * df$pFU1 + (df$FU1 == "No") * (1 - df$pFU1)
df$wFU2 <- (df$FU2 == 1) * df$pFU2 + (df$FU2 == 0) * (1 - df$pFU2)
df$w <- 1/(df$wFU1 * df$wFU2)
rm(gFU1)
rm(gFU2)
#df$I_A <- df$FU1 == "No" & df$FU2 == 0  #indicators, prob not needed
#df$I_AB <- df$FU1 == "Yes" & df$FU2 == 0
#df$I_AC <- df$FU1 == "No" & df$FU2 == 1
#df$I_ABC <- df$FU1 == "Yes" & df$FU2 == 1

#select people with no LTFU
#dfc <- subset(df, FU2==1 & FU1=="Yes")

#create key variables not asked at baseline
df$ARREST <- rep(NA)
df$POLICE <- rep(NA)
df$JAIL <- rep(NA)

#select variables
dfs <- df %>%
  dplyr::select("SUBJECT", "GENDER", "AGE", "RACELG", "HOMELESS", "HOMELESS1", "HOMELESS2", "MOSHOME", "MOSHOME1", "MOSHOM2", "RECSHR", "RECSHR1", "RECSHR2", "PUBINJ", "PUBINJ1", "PUBINJ2", "IJWOTH", "IJWOTH1", "IJWOTH2", 
        "POLICE", "POLICE1", "POLICE2", "ARREST", "ARREST1", "ARREST2", "JAIL", "JAIL1", "JAIL2", "w")

#make dataset long format
dfslong <- reshape(dfs, idvar = "SUBJECT", varying = list(c("HOMELESS", "HOMELESS1", "HOMELESS2"), c("MOSHOME", "MOSHOME1", "MOSHOM2"), c("RECSHR", "RECSHR1", "RECSHR2"), c("PUBINJ", "PUBINJ1", "PUBINJ2"), c("IJWOTH", "IJWOTH1", "IJWOTH2"), c("POLICE", "POLICE1", "POLICE2"), c("ARREST", "ARREST1", "ARREST2"), c("JAIL", "JAIL1", "JAIL2")), timevar = "VISIT", v.names = c("HOMELESS", "MOSHOME", "TIMESHARE", "PUBINJ", "IJWOTH", "POLICE", "ARREST", "JAIL"), ids = "SUBJECT", times = c("baseline", "FU1", "FU2"), direction = "long")

#update variable types
dfslong$TIMESHARE <- as.numeric(dfslong$TIMESHARE)
dfslong$POLICE <- as.factor(dfslong$POLICE)
dfslong$ARREST <- as.factor(dfslong$ARREST)
dfslong$JAIL <- as.factor(dfslong$JAIL)
dfslong$VISIT <- as.factor(dfslong$VISIT)
dfslong$MOSHOME <- as.numeric(dfslong$MOSHOME)
```

```{r dataplay, include=FALSE}
#USE THIS CODE TO LOOK UP A VARIABLE DESCRIPTION
#df.labels$description[df.labels$VAR_ID=="GENDER"]

#inspect the data
names(df)
dim(df)
length(unique(dfs$SUBJECT))

table(dfs$GENDER, useNA = "ifany")
table(dfs$FU1, useNA = "ifany")
table(dfs$FU2, useNA = "ifany")

#look at homeless variables
table(dfs$HOMELESS, useNA = "ifany")
table(dfs$HOMELESS1, useNA = "ifany")
table(dfs$HOMELESS2, useNA = "ifany")

#look at homeless variables ricky created
table(dfs$NVHOUSED, useNA = "ifany")
table(dfs$ALWYSHL, useNA = "ifany")
table(dfs$HOUSED, useNA = "ifany")

#look at initiation variables
apply(dfs[c("HLP6M", "HLP6M1", "HLP6M2")], 2, table)

#look at arrest
table(dfs$ARREST2, useNA = "ifany")

#look at public injecting variables. could dichotomize never vs at all.
#could look at homelessness - public injection association
#could look at public injecting leads to sharing syringes more often.
#seems to be big diff in syringe sharing between LA and SF
table(dfs$PUBINJ)
table(dfs$PUBINJ1)
table(dfs$PUBINJ2)

#look at syringe sharing variable
table(dfc$Rshare)
table(dfc$Rshare1)
table(dfc$Rshare2)
```


```{r analysis, include=TRUE}
#analysis using reweighted sample

#maybe gee? but too much informative censoring. this isn't working, not sure why?
id = dfslong$SUBJECT

library(gee)
modelgee <- gee(TIMESHARE ~ PUBINJ + MOSHOME + GENDER + AGE + RACELG, id, data=dfslong,family=poisson, corstr = "independence")

#maybe mixed effects model?
modelp <- glmer(TIMESHARE ~ PUBINJ + MOSHOME + GENDER + AGE + RACELG+(1|id), family = "poisson", data = dfslong)
summary(modelp)

summary(modelp)

#modelnb <- glmer.nb(log(TIMESHARE) ~ PUBINJ + MOSHOME + IJWOTH + GENDER + AGE + RACELG + (1|SUBJECT), weights = w,  data = dfslong, na.action = na.omit)
#summary(modelnb)
```

Notes for Alan:

(NB: We know that for the final project we'll need to do various things to explore, etc. but for now wanted to see if we could get some sort of regression to work, then were planning on backing up a bit to clean it up.)

Something's not right with this model (see row 136). Suspect it has to do with NAs in our dataset, but because of loss to F/U this is going to happen! Do we delete rows with NAs before analysis?

We were getting warnings about failure to converge with suggestion to rescale - tried making the outcome in log scale (and dropped HOMELESS and IJWOTH to simplify) and with those changes it eventually does converge after many minutes, but summary(modelp) produces some really funky stuff and then two warning messages:

1: In vcov.merMod(object, use.hessian = use.hessian) :
  variance-covariance matrix computed from finite-difference Hessian is
not positive definite or contains NA values: falling back to var-cov estimated from RX
2: In vcov.merMod(object, correlation = correlation, sigm = sig) :
  variance-covariance matrix computed from finite-difference Hessian is
not positive definite or contains NA values: falling back to var-cov estimated from RX

The NB version of the model never finishes. What to do?

interaction between homelessness and public injecting
random coefficients for levels of pubinj and mos homelessness
contrast mixed model with gee


```{r}
library(gee)
gee_alan_mtg <- gee(TIMESHARE ~ factor(PUBINJ) + MOSHOME + GENDER + AGE + RACELG, id, family = "poisson", data = dfslong,na.action = na.omit)
```


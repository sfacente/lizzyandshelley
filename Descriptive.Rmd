---
title: "242 Final Project"
author: "Lizzy Kinnard and Shelley Facente"
date: "November 10, 2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#open packages
library(here)
library(foreign)
library(labelled)
library(dplyr)
library(reshape2)
library(lme4)
library(MASS)
```

```{r dataload, include=FALSE}
#set working directory
setwd("~/Desktop/lizzyandshelley/Dataset") #LIZZY
#setwd("~/GitHub/lizzyandshelley/Dataset")  #SHELLEY

#load the data
df <- read.spss("Ricky.SAV", use.value.labels = TRUE, to.data.frame=TRUE)

#get variable labels
attr(df, "variable.labels")
df.labels <- as.data.frame(attr(df, "variable.labels"))
QDSlabels <- data.frame(rownames(df.labels))
df.labels <- cbind(QDSlabels, df.labels)
names(df.labels) <- c("VAR_ID", "description")
rm(QDSlabels)

#clean up data types
df$MOSHOME <- as.numeric(df$MOSHOME)
df$MOSHOME1 <- as.numeric(df$MOSHOME1)
df$MOSHOME[is.na(df$MOSHOME)] <- 0
df$MOSHOME1[is.na(df$MOSHOME1)] <- 0
df$AGE <- as.numeric(df$AGE)
df$Rshare1[is.na(df$Rshare1)] <- "No" ################
df$HOMELESS1[is.na(df$HOMELESS1)] <- "No" ################
df$IJWOTH1[is.na(df$IJWOTH1)] <- "Never (0% of the time)" ################
df$PUBINJ1[is.na(df$PUBINJ1)] <- "Never (0% of the time)" ################
df$Rshare1 <- factor(df$Rshare1)

#reweight sample to address LTFU
#df$I_A <- df$FU1 == "No" & df$FU2 == 0  #indicators, prob not needed
#df$I_AB <- df$FU1 == "Yes" & df$FU2 == 0
#df$I_AC <- df$FU1 == "No" & df$FU2 == 1
#df$I_ABC <- df$FU1 == "Yes" & df$FU2 == 1
gFU1 <- glm(FU1 ~ Rshare + PUBINJ + HOMELESS + MOSHOME + IJWOTH + GENDER + AGE + RACELG, family = "binomial", data = df, na.action = na.omit) 
df <- subset(df, SUBJECT!=4394) ################
df <- subset(df, SUBJECT!=4457) ################
df <- subset(df, SUBJECT!=5267) ################
gFU2 <- glm(FU2 ~ FU1 + Rshare1 + PUBINJ1 + HOMELESS1 + MOSHOME1 + IJWOTH1 + GENDER + AGE + RACELG, family = "binomial", data = df, na.action = na.omit) 
df$pFU1 <- predict(gFU1, type = "response")
df$pFU2 <- predict(gFU2, type = "response")
df$wFU1 <- (df$FU1 == "Yes") * df$pFU1 + (df$FU1 == "No") * (1 - df$pFU1)
df$wFU2 <- (df$FU2 == 1) * df$pFU2 + (df$FU2 == 0) * (1 - df$pFU2)
df$w <- 1/(df$wFU1 * df$wFU2)
rm(gFU1)
rm(gFU2)

#select people with no LTFU
#dfc <- subset(df, FU2==1 & FU1=="Yes")

#create key variables not asked at baseline
df$ARREST <- rep(NA)
df$POLICE <- rep(NA)
df$JAIL <- rep(NA)

#select variables
dfs <- df %>%
  dplyr::select("SUBJECT", "GENDER", "AGE", "RACELG", "HOMELESS", "HOMELESS1", "HOMELESS2", "MOSHOME", "MOSHOME1", "MOSHOM2", "RECSHR", "RECSHR1", "RECSHR2", "PUBINJ", "PUBINJ1", "PUBINJ2", "IJWOTH", "IJWOTH1", "IJWOTH2", 
        "POLICE", "POLICE1", "POLICE2", "ARREST", "ARREST1", "ARREST2", "JAIL", "JAIL1", "JAIL2", "w")

#make dataset long format
dfslong <- reshape(dfs, idvar = "SUBJECT", varying = list(c("HOMELESS", "HOMELESS1", "HOMELESS2"), c("MOSHOME", "MOSHOME1", "MOSHOM2"), c("RECSHR", "RECSHR1", "RECSHR2"), c("PUBINJ", "PUBINJ1", "PUBINJ2"), c("IJWOTH", "IJWOTH1", "IJWOTH2"), c("POLICE", "POLICE1", "POLICE2"), c("ARREST", "ARREST1", "ARREST2"), c("JAIL", "JAIL1", "JAIL2")), timevar = "VISIT", v.names = c("HOMELESS", "MOSHOME", "TIMESHARE", "PUBINJ", "IJWOTH", "POLICE", "ARREST", "JAIL"), ids = "SUBJECT", times = c("baseline", "FU1", "FU2"), direction = "long")

#update variable types
dfslong$TIMESHARE <- as.numeric(dfslong$TIMESHARE)
dfslong$POLICE <- as.factor(dfslong$POLICE)
dfslong$ARREST <- as.factor(dfslong$ARREST)
dfslong$JAIL <- as.factor(dfslong$JAIL)
dfslong$VISIT <- as.factor(dfslong$VISIT)
dfslong$MOSHOME <- as.numeric(dfslong$MOSHOME)
```

```{r dataplay, include=FALSE}
#USE THIS CODE TO LOOK UP A VARIABLE DESCRIPTION
#df.labels$description[df.labels$VAR_ID=="GENDER"]

#inspect the data
names(dfslong)
dim(dfslong)
length(unique(dfs$SUBJECT))

#look at public injecting variables. could dichotomize never vs at all.
#could look at homelessness - public injection association
#could look at public injecting leads to sharing syringes more often.
#seems to be big diff in syringe sharing between LA and SF
```


```{r analysis, include=TRUE}
#analysis using reweighted sample
modelp <- glmer(log(TIMESHARE) ~ PUBINJ + MOSHOME + GENDER + AGE + RACELG + (1|SUBJECT), family = "poisson", weights = w, data = dfslong, na.action = na.omit)
summary(modelp)

#modelnb <- glmer.nb(log(TIMESHARE) ~ PUBINJ + MOSHOME + IJWOTH + GENDER + AGE + RACELG + (1|SUBJECT), weights = w,  data = dfslong, na.action = na.omit)
#summary(modelnb)
```

Notes for Alan:

(NB: We know that for the final project we'll need to do various things to explore, etc. but for now wanted to see if we could get some sort of regression to work, then were planning on backing up a bit to clean it up.)

1) When we tried to reweight the sample to address LTFU (using IP"FU"W) we ran into some problems with the glm. Ended up having to set NAs to zeros in some variables (not desired, see rows 43-46) as well as having to drop a few cases that still were causing problems with the predict function (see rows 55-57). Any ideas?

2) Something's not right with this model (see row 110). We were getting warnings about failure to converge with suggestion to rescale - tried making the outcome in log scale (and dropped HOMELESS and IJWOTH to simplify) and with those changes it eventually does converge after many minutes, but summary(modelp) produces some really funky stuff and then two warning messages. The NB version of the model never finishes. Help?!

---
title: "242 Final Project"
author: "Lizzy Kinnard and Shelley Facente"
date: "November 21, 2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#open packages
library(here)
library(foreign)
library(labelled)
library(dplyr)
library(reshape2)
library(lme4)
library(MASS)
library(mice)
```

```{r dataload, include=FALSE}
#set working directory
#setwd("~/Desktop/lizzyandshelley/Dataset") #LIZZY
setwd("~/GitHub/lizzyandshelley/Dataset")  #SHELLEY

#load the data
df <- read.spss("Ricky.SAV", use.value.labels = TRUE, to.data.frame=TRUE)

#get variable labels
attr(df, "variable.labels")
df.labels <- as.data.frame(attr(df, "variable.labels"))
QDSlabels <- data.frame(rownames(df.labels))
df.labels <- cbind(QDSlabels, df.labels)
names(df.labels) <- c("VAR_ID", "description")
rm(QDSlabels)

#USE THIS CODE TO LOOK UP A VARIABLE DESCRIPTION
#df.labels$description[df.labels$VAR_ID=="GENDER"]

#clean up data types
df$MOSHOME <- as.numeric(df$MOSHOME)
df$MOSHOME1 <- as.numeric(df$MOSHOME1)
df$MOSHOME[is.na(df$MOSHOME)] <- 0
df$MOSHOME1[is.na(df$MOSHOME1)] <- 0
df$AGE <- as.numeric(df$AGE)
df$Rshare1 <- factor(df$Rshare1)

#create key variables not asked at baseline
df$ARREST <- rep(NA)
df$POLICE <- rep(NA)
df$JAIL <- rep(NA)

#select variables
dfs <- df %>%
  dplyr::select("SUBJECT", "FU1", "FU2", "GENDER", "AGE", "RACELG", "HOMELESS", "HOMELESS1", "HOMELESS2", "MOSHOME", "MOSHOME1", "MOSHOM2", "RECSHR", "RECSHR1", "RECSHR2", "PUBINJ", "PUBINJ1", "PUBINJ2", "IJWOTH", "IJWOTH1", "IJWOTH2", "POLICE", "POLICE1", "POLICE2", "ARREST", "ARREST1", "ARREST2", "JAIL", "JAIL1", "JAIL2", "Rshare", "Rshare1", "Rshare2")

#look at missingness
missing <- data.frame(md.pattern(dfs))

#remove subjects with NA for exposure or outcome 
dfs <- subset(dfs, SUBJECT!=4394) 
dfs <- subset(dfs, SUBJECT!=4457) 
dfs <- subset(dfs, SUBJECT!=5055)
dfs <- subset(dfs, SUBJECT!=5267)
dfs <- subset(dfs, SUBJECT!=5276)
dfs <- subset(dfs, SUBJECT!=5277)

# #figure out any additional cases that will be dropped from glms below
# dfsglm <- dfs %>%
#   dplyr::select("SUBJECT", "GENDER", "AGE", "HOMELESS", "MOSHOME", "PUBINJ", "IJWOTH","RECSHR")
# dfsglm$SUBJECT[which(! complete.cases(dfsglm))]

#impute missing covariates
keeps <- c("SUBJECT", "GENDER", "AGE", "IJWOTH", "IJWOTH1", "IJWOTH2", "POLICE1", "POLICE2", "ARREST1", "ARREST2", "JAIL1", "JAIL2")
keeps2 <- c("GENDER", "AGE", "IJWOTH", "IJWOTH1", "IJWOTH2", "POLICE1", "POLICE2", "ARREST1", "ARREST2", "JAIL1", "JAIL2")
imputation <- mice(dfs[, (names(dfs) %in% keeps)], m=5, maxit=5, printFlag=TRUE, seed = 242)
dfs1 <- complete(imputation, 1)
dfs1 <- merge(dfs1, dfs[, !(names(dfs) %in% keeps2)], by = "SUBJECT")
dfs2 <- complete(imputation, 2)
dfs2 <- merge(dfs2, dfs[, !(names(dfs) %in% keeps2)], by = "SUBJECT")
dfs3 <- complete(imputation, 3)
dfs3 <- merge(dfs3, dfs[, !(names(dfs) %in% keeps2)], by = "SUBJECT")
dfs4 <- complete(imputation, 4)
dfs4 <- merge(dfs4, dfs[, !(names(dfs) %in% keeps2)], by = "SUBJECT")
dfs5 <- complete(imputation, 5)
dfs5 <- merge(dfs5, dfs[, !(names(dfs) %in% keeps2)], by = "SUBJECT")

#reweight sample to address LTFU
I_ABC <- dfs$FU1 == "Yes" & dfs$FU2 == 1
gFU1a <- glm(FU1 ~ RECSHR + PUBINJ + HOMELESS + MOSHOME + IJWOTH + GENDER + AGE, family = "binomial", data = dfs1, na.action = na.omit)
gFU1b <- glm(FU1 ~ RECSHR + PUBINJ + HOMELESS + MOSHOME + IJWOTH + GENDER + AGE, family = "binomial", data = dfs2, na.action = na.omit)
gFU1c <- glm(FU1 ~ RECSHR + PUBINJ + HOMELESS + MOSHOME + IJWOTH + GENDER + AGE, family = "binomial", data = dfs3, na.action = na.omit)
gFU1d <- glm(FU1 ~ RECSHR + PUBINJ + HOMELESS + MOSHOME + IJWOTH + GENDER + AGE, family = "binomial", data = dfs4, na.action = na.omit)
gFU1e <- glm(FU1 ~ RECSHR + PUBINJ + HOMELESS + MOSHOME + IJWOTH + GENDER + AGE, family = "binomial", data = dfs5, na.action = na.omit)
pFU1a <- predict(gFU1a, type = "response")
pFU1b <- predict(gFU1b, type = "response")
pFU1c <- predict(gFU1c, type = "response")
pFU1d <- predict(gFU1d, type = "response")
pFU1e <- predict(gFU1e, type = "response")
impFU1 <-data.frame(pFU1a, pFU1b, pFU1c, pFU1d, pFU1e)
dfs$pFU1 <- rowMeans(impFU1)
gFU2a <- glm(FU2 ~ FU1 + Rshare + PUBINJ + HOMELESS + MOSHOME + IJWOTH + GENDER + AGE, family = "binomial", data = dfs1, na.action = na.omit) 
gFU2b <- glm(FU2 ~ FU1 + Rshare + PUBINJ + HOMELESS + MOSHOME + IJWOTH + GENDER + AGE, family = "binomial", data = dfs2, na.action = na.omit) 
gFU2c <- glm(FU2 ~ FU1 + Rshare + PUBINJ + HOMELESS + MOSHOME + IJWOTH + GENDER + AGE, family = "binomial", data = dfs3, na.action = na.omit) 
gFU2d <- glm(FU2 ~ FU1 + Rshare + PUBINJ + HOMELESS + MOSHOME + IJWOTH + GENDER + AGE, family = "binomial", data = dfs4, na.action = na.omit) 
gFU2e <- glm(FU2 ~ FU1 + Rshare + PUBINJ + HOMELESS + MOSHOME + IJWOTH + GENDER + AGE, family = "binomial", data = dfs5, na.action = na.omit) 
pFU2a <- predict(gFU2a, type = "response")
pFU2b <- predict(gFU2b, type = "response")
pFU2c <- predict(gFU2c, type = "response")
pFU2d <- predict(gFU2d, type = "response")
pFU2e <- predict(gFU2e, type = "response")
impFU2 <-data.frame(pFU2a, pFU2b, pFU2c, pFU2d, pFU2e)
dfs$pFU2 <- rowMeans(impFU2)
dfs$w <- I_ABC/(dfs$pFU1 * dfs$pFU2)
rm(gFU1a, gFU1b, gFU1c, gFU1d, gFU1e, gFU2a, gFU2b, gFU2c, gFU2d, gFU2e, pFU1a, pFU1b, pFU1c, pFU1d, pFU1e, pFU2a, pFU2b, pFU2c, pFU2d, pFU2e, impFU1, impFU2)

#select people with no LTFU (complete case)
#dfc <- subset(df, FU2==1 & FU1=="Yes")

#make dataset long format
dfslong <- reshape(dfs, idvar = "SUBJECT", varying = list(c("HOMELESS", "HOMELESS1", "HOMELESS2"), c("MOSHOME", "MOSHOME1", "MOSHOM2"), c("RECSHR", "RECSHR1", "RECSHR2"), c("PUBINJ", "PUBINJ1", "PUBINJ2"), c("IJWOTH", "IJWOTH1", "IJWOTH2"), c("POLICE", "POLICE1", "POLICE2"), c("ARREST", "ARREST1", "ARREST2"), c("JAIL", "JAIL1", "JAIL2")), timevar = "VISIT", v.names = c("HOMELESS", "MOSHOME", "TIMESHARE", "PUBINJ", "IJWOTH", "POLICE", "ARREST", "JAIL"), ids = "SUBJECT", times = c("baseline", "FU1", "FU2"), direction = "long")

#update variable types
dfslong$TIMESHARE <- as.numeric(dfslong$TIMESHARE)
dfslong$POLICE <- as.factor(dfslong$POLICE)
dfslong$ARREST <- as.factor(dfslong$ARREST)
dfslong$JAIL <- as.factor(dfslong$JAIL)
dfslong$VISIT <- as.factor(dfslong$VISIT)
dfslong$MOSHOME <- as.numeric(dfslong$MOSHOME)

dfslong$PUBINJord <- as.numeric(ifelse(dfslong$PUBINJ=="Never (0% of the time)", 0, ifelse(dfslong$PUBINJ=="Occasionally (less than 25% of the time)", 1, ifelse(dfslong$PUBINJ=="Sometimes (25% to 74% of the time)", 2, ifelse(dfslong$PUBINJ=="Usually (75% to 99% of the time)", 3, ifelse(dfslong$PUBINJ=="Always (100% of the time)", 4 ,NA))))))

dfslong$IJWOTHord <- as.numeric(ifelse(dfslong$IJWOTH=="Never (0% of the time)", 0, ifelse(dfslong$IJWOTH=="Occasionally (less than 25% of the time)", 1, ifelse(dfslong$IJWOTH=="Sometimes (25% to 74% of the time)", 2, ifelse(dfslong$IJWOTH=="Usually (75% to 99% of the time)", 3, ifelse(dfslong$IJWOTH=="Always (100% of the time)", 4, NA))))))

dfslong$YRSHOME <- dfslong$MOSHOME/12
```

Analysis:

```{r analysis, include=TRUE, cache=TRUE}
######################################################################################################
########NOTE THAT RIGHT NOW WE ARE NOT REWEIGHTING THE SAMPLE, SHELLEY TO CHECK WITH MAYA#############
########LIZZY COMMENTED OUT ALL THE LINES WITH REWEIGHTING SO IT WOULDN'T DISTRICT US FOR NOW#########
######################################################################################################

#gee model (no time-invariant covariates)
#NOTE THAT THIS CURRENTLY INCLUDES POLICE, ARREST, and JAIL - do we want to drop?? Mixed effects models don't include these (though could)
#Why is there no main effect of public injecting?
library(gee)
modelgee <- gee(TIMESHARE ~ PUBINJord*YRSHOME + HOMELESS + PUBINJord*IJWOTHord + POLICE + ARREST + JAIL, SUBJECT, data = dfslong, family = poisson, corstr = "exchangeable", na.action = na.omit)
summary(modelgee)

#mixed effects models
modelpoisson <- glmer(TIMESHARE ~ PUBINJord*YRSHOME + HOMELESS + PUBINJord*IJWOTHord + GENDER + AGE + RACELG + (1|SUBJECT), family = "poisson", data = dfslong, na.action = na.omit)
summary(modelpoisson)

modelnb <- glmer.nb(TIMESHARE ~ PUBINJord*YRSHOME + HOMELESS + PUBINJord*IJWOTHord + GENDER + AGE + RACELG + (1|SUBJECT), data = dfslong, na.action = na.omit)
summary(modelnb)
```


```{r}
#trying to plot public injecting against sharing to see what it looks like visually
simple_plot <- glm(TIMESHARE ~ PUBINJord, family = "poisson", data = dfslong, na.action = na.omit)

#code not working
plot(dfslong$PUBINJord, predict(simple_plot, type="link"))
```

Tasks for Lizzy:
- create substance use indicator variables
- look into those who werenâ€™t homeless but injected outside
- consider treating homelessness as a categorical rather than continuous variable. I am not sure what it means to have an interaction term with ordinal*continuous?
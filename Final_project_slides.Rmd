---
title: "242 Final Project"
author: "Lizzy Kinnard and Shelley Facente"
date: "November 21, 2019"
output: beamer_presentation
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#open packages
library(here)
library(foreign)
library(labelled)
library(dplyr)
library(reshape2)
library(lme4)
library(MASS)
library(mice)
library(biostat3)
library(lmtest)
library(gee)
```

```{r dataload, include=FALSE, cache = TRUE}
#set working directory
#setwd("~/Desktop/lizzyandshelley/Dataset") #LIZZY
setwd("~/GitHub/lizzyandshelley/Dataset")  #SHELLEY

#load the data
df <- read.spss("Ricky.SAV", use.value.labels = TRUE, to.data.frame=TRUE)

#get variable labels
attr(df, "variable.labels")
df.labels <- as.data.frame(attr(df, "variable.labels"))
QDSlabels <- data.frame(rownames(df.labels))
df.labels <- cbind(QDSlabels, df.labels)
names(df.labels) <- c("VAR_ID", "description")
rm(QDSlabels)

#USE THIS CODE TO LOOK UP A VARIABLE DESCRIPTION
#df.labels$description[df.labels$VAR_ID=="GENDER"]

#create substance use indicators

# #crack injection
# table(df$CRKINJ, useNA = "ifany")

df$CRKINJ1 <- ifelse(df$CRKINJ1=="No", "No", ifelse(df$CRKINJ1=="Yes", "Yes", NA))
# table(df$CRKINJ1, useNA = "ifany")
# table(df$CRKINJ2, useNA = "ifany")
# 
# 
# #powder cocaine injection
# table(df$CCINJ, useNA = "ifany")

df$CCINJ1 <- ifelse(df$CCINJ1=="No", "No", ifelse(df$CCINJ1=="Yes", "Yes", NA))
# table(df$CCINJ1, useNA = "ifany")
# table(df$CCINJ2, useNA = "ifany")
# 
# 
# #meth injection
# table(df$MTINJ, useNA = "ifany")

df$MTINJ1 <- ifelse(df$MTINJ1=="No", "No", ifelse(df$MTINJ1=="Yes", "Yes", NA))

# table(df$MTINJ1, useNA = "ifany")
# table(df$MTINJ2, useNA = "ifany")
# 

#injection of prescription stimulants
#table(df$STINJ, useNA = "ifany")

df$STINJ1 <- ifelse(df$STINJ1=="No", "No", ifelse(df$STINJ1=="Yes", "Yes", NA))

#table(df$STINJ1, useNA = "ifany")
#table(df$STINJ2, useNA = "ifany")


# #heroin injection
# table(df$HRINJ, useNA = "ifany")

df$HRINJ1 <- ifelse(df$HRINJ1=="No", "No", ifelse(df$HRINJ1=="Yes", "Yes", NA))
# table(df$HRINJ1, useNA = "ifany")
# table(df$HRINJ2, useNA = "ifany")

# # NMPO injection
# table(df$OPINJ, useNA = "ifany")

df$OPINJ1 <- ifelse(df$OPINJ1=="No", "No", ifelse(df$OPINJ1=="Yes", "Yes", NA))
# table(df$OPINJ1, useNA = "ifany")
# table(df$OPINJ2, useNA = "ifany")
# 
# #alcohol
df$ALCDAY <- as.numeric(df$ALCDAY)
df$ALCDAY1 <- as.numeric(df$ALCDAY1)
df$ALCDAY2 <- as.numeric(df$ALCDAY2)

df$ALCTX <- as.numeric(df$ALCTX)
df$ALCTX1 <- as.numeric(df$ALCTX1)
df$ALCTX2 <- as.numeric(df$ALCTX2)

#binge alcohol on a typical day
#binge baseline
df$binge <- ifelse(df$ALCDAY==0, 0, ifelse(df$ALCTX<4, 0, ifelse(df$ALCTX>3, 1, NA)))
#binge FU1 
df$binge1 <- ifelse(df$ALCDAY1==0, 0, ifelse(df$ALCTX1<4, 0, ifelse(df$ALCTX1>3, 1, NA)))
#binge FU2
df$binge2 <- ifelse(df$ALCDAY2==0, 0, ifelse(df$ALCTX2<4, 0, ifelse(df$ALCTX2>3, 1, NA)))

#any stimulant injection
#any stimulant injection baseline
df$ANYSTIM <- ifelse(df$CRKINJ=="Yes" | df$CCINJ=="Yes" | df$MTINJ=="Yes" | df$STINJ=="Yes", 1, ifelse(df$CRKINJ=="No" & df$CCINJ=="No" & df$MTINJ=="No" & df$STINJ=="No", 0, NA))
#any stimulant injection FU1
df$ANYSTIM1 <- ifelse(df$CRKINJ1=="Yes" | df$CCINJ1=="Yes" | df$MTINJ1=="Yes" | df$STINJ1=="Yes", 1, ifelse(df$CRKINJ1=="No" & df$CCINJ1=="No" & df$MTINJ1=="No" & df$STINJ1=="No", 0, NA))
#any stimulant injection FU2
df$ANYSTIM2 <- ifelse(df$CRKINJ2=="Yes" | df$CCINJ2=="Yes" | df$MTINJ2=="Yes" | df$STINJ2=="Yes", 1, ifelse(df$CRKINJ2=="No" & df$CCINJ2=="No" & df$MTINJ2=="No" & df$STINJ2=="No", 0, NA))

#any opioid injection
#any opioid injection baseline
df$ANYOPIATE <- ifelse(df$HRINJ=="Yes" | df$OPINJ=="Yes", 1, ifelse(df$HRINJ=="No" & df$OPINJ=="No", 0, NA))
#any opioid injection FU1
df$ANYOPIATE1 <- ifelse(df$HRINJ1=="Yes" | df$OPINJ1=="Yes", 1, ifelse(df$HRINJ1=="No" & df$OPINJ1=="No", 0, NA))
#any opioid injection FU2
df$ANYOPIATE2 <- ifelse(df$HRINJ2=="Yes" | df$OPINJ2=="Yes", 1, ifelse(df$HRINJ2=="No" & df$OPINJ2=="No", 0, NA))

#clean up data types
df$MOSHOME <- as.numeric(paste(df$MOSHOME))
df$MOSHOME1 <- as.numeric(paste(df$MOSHOME1))
df$MOSHOM2 <- as.numeric(paste(df$MOSHOM2))
df$MOSHOME[is.na(df$MOSHOME)] <- 0
df$MOSHOME1[is.na(df$MOSHOME1)] <- 0
df$MOSHOM2[is.na(df$MOSHOM2)] <- 0
df$AGE <- as.numeric(paste(df$AGE))
df$Rshare1 <- factor(df$Rshare1)
#df$HOMELESS <- as.numeric(df$HOMELESS)

########HAD TO CATEGORIZE AGE BECAUSE NB MODEL WOULDN'T CONVERGE###########
df$AGE_cat <- as.factor(ifelse(df$AGE<25, "y", ifelse(df$AGE>24 & df$AGE<41, "m", ifelse(df$AGE>40, "e", NA))))

#calculate syringe sharing rate
df$RECSHR <- as.numeric(levels(df$RECSHR))[df$RECSHR]
df$RECSHR1 <- as.numeric(levels(df$RECSHR1))[df$RECSHR1]
df$RECSHR2 <- as.numeric(levels(df$RECSHR2))[df$RECSHR2]
shared0 <- sum(df$RECSHR>0, na.rm = TRUE)
shared2 <- sum(df$RECSHR2>0, na.rm = TRUE)
sharerate0 <- (sum(df$RECSHR[df$RECSHR>0], na.rm = TRUE)/shared0)
sharerate2 <- (sum(df$RECSHR2[df$RECSHR2>0], na.rm = TRUE)/shared2)

#create key variables not asked at baseline
df$ARREST <- rep(NA)
df$POLICE <- rep(NA)
df$JAIL <- rep(NA)

#select variables
dfs <- df %>%
  dplyr::select("SUBJECT", "FU1", "FU2", "GENDER", "AGE", "AGE_cat", "RACELG", "HOMELESS", "HOMELESS1", "HOMELESS2", "MOSHOME", "MOSHOME1", "MOSHOM2", "RECSHR", "RECSHR1", "RECSHR2", "PUBINJ", "PUBINJ1", "PUBINJ2", "IJWOTH", "IJWOTH1", "IJWOTH2", "POLICE", "POLICE1", "POLICE2", "ARREST", "ARREST1", "ARREST2", "JAIL", "JAIL1", "JAIL2", "Rshare", "Rshare1", "Rshare2", "binge", "binge1", "binge2", "ANYSTIM", "ANYSTIM1", "ANYSTIM2", "ANYOPIATE", "ANYOPIATE1", "ANYOPIATE2")

#recategorize PUBINJ
dfs$PUBINJ_3cat <- as.factor(ifelse(dfs$PUBINJ=="Never (0% of the time)", 0, ifelse(dfs$PUBINJ=="Occasionally (less than 25% of the time)" | dfs$PUBINJ=="Sometimes (25% to 74% of the time)", 1, ifelse(dfs$PUBINJ=="Usually (75% to 99% of the time)" | dfs$PUBINJ=="Always (100% of the time)", 2, NA))))
dfs$PUBINJ1_3cat <- as.factor(ifelse(dfs$PUBINJ1=="Never (0% of the time)", 0, ifelse(dfs$PUBINJ1=="Occasionally (less than 25% of the time)" | dfs$PUBINJ1=="Sometimes (25% to 74% of the time)", 1, ifelse(dfs$PUBINJ1=="Usually (75% to 99% of the time)" | dfs$PUBINJ1=="Always (100% of the time)", 2, NA))))
dfs$PUBINJ2_3cat <- as.factor(ifelse(dfs$PUBINJ2=="Never (0% of the time)", 0, ifelse(dfs$PUBINJ2=="Occasionally (less than 25% of the time)" | dfs$PUBINJ2=="Sometimes (25% to 74% of the time)", 1, ifelse(dfs$PUBINJ2=="Usually (75% to 99% of the time)" | dfs$PUBINJ2=="Always (100% of the time)", 2, NA))))

#look at missingness
missing <- data.frame(md.pattern(dfs))

#remove subjects with NA for exposure or outcome 
dfs <- subset(dfs, SUBJECT!=4394) 
dfs <- subset(dfs, SUBJECT!=4457) 
dfs <- subset(dfs, SUBJECT!=5055)
dfs <- subset(dfs, SUBJECT!=5267)
dfs <- subset(dfs, SUBJECT!=5276)
dfs <- subset(dfs, SUBJECT!=5277)

# #figure out any additional cases that will be dropped from glms below
# dfsglm <- dfs %>%
#   dplyr::select("SUBJECT", "GENDER", "AGE", "HOMELESS", "MOSHOME", "PUBINJ", "IJWOTH","RECSHR", "binge", "ANYSTIM", "ANYOPIATE")
# dfsglm$SUBJECT[which(! complete.cases(dfsglm))]

#impute missing covariates
impute <- c("SUBJECT", "GENDER", "AGE", "IJWOTH", "IJWOTH1", "IJWOTH2", "POLICE1", "POLICE2", "ARREST1", "ARREST2", "JAIL1", "JAIL2", "binge", "ANYSTIM", "ANYOPIATE", "binge1", "ANYSTIM1", "ANYOPIATE1", "binge2", "ANYSTIM2", "ANYOPIATE2")
keeps <- c("GENDER", "AGE", "IJWOTH", "IJWOTH1", "IJWOTH2", "POLICE1", "POLICE2", "ARREST1", "ARREST2", "JAIL1", "JAIL2", "binge", "ANYSTIM", "ANYOPIATE", "binge1", "ANYSTIM1", "ANYOPIATE1", "binge2", "ANYSTIM2", "ANYOPIATE2")
imputation <- mice(dfs[, (names(dfs) %in% impute)], m=5, maxit=5, printFlag=TRUE, seed = 242)
dfs1 <- complete(imputation, 1)
dfs1 <- merge(dfs1, dfs[, !(names(dfs) %in% keeps)], by = "SUBJECT")
dfs2 <- complete(imputation, 2)
dfs2 <- merge(dfs2, dfs[, !(names(dfs) %in% keeps)], by = "SUBJECT")
dfs3 <- complete(imputation, 3)
dfs3 <- merge(dfs3, dfs[, !(names(dfs) %in% keeps)], by = "SUBJECT")
dfs4 <- complete(imputation, 4)
dfs4 <- merge(dfs4, dfs[, !(names(dfs) %in% keeps)], by = "SUBJECT")
dfs5 <- complete(imputation, 5)
dfs5 <- merge(dfs5, dfs[, !(names(dfs) %in% keeps)], by = "SUBJECT")

#reweight sample to address LTFU
I_ABC <- dfs$FU1 == "Yes" & dfs$FU2 == 1
gFU1a <- glm(FU1 ~ RECSHR + PUBINJ_3cat + HOMELESS + IJWOTH + GENDER + AGE + ANYSTIM, family = "binomial", data = dfs1, na.action = na.omit)
gFU1b <- glm(FU1 ~ RECSHR + PUBINJ_3cat + HOMELESS + IJWOTH + GENDER + AGE + ANYSTIM, family = "binomial", data = dfs2, na.action = na.omit)
gFU1c <- glm(FU1 ~ RECSHR + PUBINJ_3cat + HOMELESS + IJWOTH + GENDER + AGE + ANYSTIM, family = "binomial", data = dfs3, na.action = na.omit)
gFU1d <- glm(FU1 ~ RECSHR + PUBINJ_3cat + HOMELESS + IJWOTH + GENDER + AGE + ANYSTIM, family = "binomial", data = dfs4, na.action = na.omit)
gFU1e <- glm(FU1 ~ RECSHR + PUBINJ_3cat + HOMELESS + IJWOTH + GENDER + AGE + ANYSTIM, family = "binomial", data = dfs5, na.action = na.omit)
pFU1a <- predict(gFU1a, type = "response")
pFU1b <- predict(gFU1b, type = "response")
pFU1c <- predict(gFU1c, type = "response")
pFU1d <- predict(gFU1d, type = "response")
pFU1e <- predict(gFU1e, type = "response")
impFU1 <-data.frame(pFU1a, pFU1b, pFU1c, pFU1d, pFU1e)
dfs$pFU1 <- rowMeans(impFU1)
gFU2a <- glm(FU2 ~ FU1 + RECSHR + PUBINJ_3cat + HOMELESS + IJWOTH + GENDER + AGE + ANYSTIM, family = "binomial", data = dfs1, na.action = na.omit) 
gFU2b <- glm(FU2 ~ FU1 + RECSHR + PUBINJ_3cat + HOMELESS + IJWOTH + GENDER + AGE + ANYSTIM, family = "binomial", data = dfs2, na.action = na.omit) 
gFU2c <- glm(FU2 ~ FU1 + RECSHR + PUBINJ_3cat + HOMELESS + IJWOTH + GENDER + AGE + ANYSTIM, family = "binomial", data = dfs3, na.action = na.omit) 
gFU2d <- glm(FU2 ~ FU1 + RECSHR + PUBINJ_3cat + HOMELESS + IJWOTH + GENDER + AGE + ANYSTIM, family = "binomial", data = dfs4, na.action = na.omit) 
gFU2e <- glm(FU2 ~ FU1 + RECSHR + PUBINJ_3cat + HOMELESS + IJWOTH + GENDER + AGE + ANYSTIM, family = "binomial", data = dfs5, na.action = na.omit) 
pFU2a <- predict(gFU2a, type = "response")
pFU2b <- predict(gFU2b, type = "response")
pFU2c <- predict(gFU2c, type = "response")
pFU2d <- predict(gFU2d, type = "response")
pFU2e <- predict(gFU2e, type = "response")
impFU2 <-data.frame(pFU2a, pFU2b, pFU2c, pFU2d, pFU2e)
dfs$pFU2 <- rowMeans(impFU2)
dfs$w <- I_ABC/(dfs$pFU1 * dfs$pFU2)
rm(gFU1a, gFU1b, gFU1c, gFU1d, gFU1e, gFU2a, gFU2b, gFU2c, gFU2d, gFU2e, pFU1a, pFU1b, pFU1c, pFU1d, pFU1e, pFU2a, pFU2b, pFU2c, pFU2d, pFU2e, impFU1, impFU2)

#select people with no LTFU (complete case)
#dfc <- subset(df, FU2==1 & FU1=="Yes")

#make dataset long format
dfslong <- reshape(dfs, idvar = "SUBJECT", varying = list(c("HOMELESS", "HOMELESS1", "HOMELESS2"), c("MOSHOME", "MOSHOME1", "MOSHOM2"), c("RECSHR", "RECSHR1", "RECSHR2"), c("PUBINJ_3cat", "PUBINJ1_3cat", "PUBINJ2_3cat"), c("IJWOTH", "IJWOTH1", "IJWOTH2"), c("POLICE", "POLICE1", "POLICE2"), c("ARREST", "ARREST1", "ARREST2"), c("JAIL", "JAIL1", "JAIL2"), c("binge", "binge1", "binge2"), c("ANYSTIM", "ANYSTIM1", "ANYSTIM2"), c("ANYOPIATE", "ANYOPIATE1", "ANYOPIATE2")), timevar = "VISIT", v.names = c("HOMELESS", "MOSHOME", "TIMESHARE", "PUBINJ_3cat", "IJWOTH", "POLICE", "ARREST", "JAIL", "binge", "ANYSTIM", "ANYOPIATE"), ids = "SUBJECT", times = c("baseline", "FU1", "FU2"), direction = "long")

#update variable types
dfslong$TIMESHARE <- as.numeric(paste(dfslong$TIMESHARE))
dfslong$POLICE <- as.factor(dfslong$POLICE)
dfslong$ARREST <- as.factor(dfslong$ARREST)
dfslong$JAIL <- as.factor(dfslong$JAIL)
dfslong$VISIT <- as.factor(dfslong$VISIT)
dfslong$MOSHOME <- as.numeric(paste(dfslong$MOSHOME))

dfslong$PUBINJord <- as.numeric(ifelse(dfslong$PUBINJ=="Never (0% of the time)", 0, ifelse(dfslong$PUBINJ=="Occasionally (less than 25% of the time)", 1, ifelse(dfslong$PUBINJ=="Sometimes (25% to 74% of the time)", 2, ifelse(dfslong$PUBINJ=="Usually (75% to 99% of the time)", 3, ifelse(dfslong$PUBINJ=="Always (100% of the time)", 4 ,NA))))))

dfslong$IJWOTHord <- as.numeric(ifelse(dfslong$IJWOTH=="Never (0% of the time)", 0, ifelse(dfslong$IJWOTH=="Occasionally (less than 25% of the time)", 1, ifelse(dfslong$IJWOTH=="Sometimes (25% to 74% of the time)", 2, ifelse(dfslong$IJWOTH=="Usually (75% to 99% of the time)", 3, ifelse(dfslong$IJWOTH=="Always (100% of the time)", 4, NA))))))

dfslong$YRSHOME <- dfslong$MOSHOME/12
```

#
## SNARKY: Sharing Needles As a Result of Kowtowing to Yuppies

\vspace{8pt}

Elizabeth Kinnard and Shelley Facente

\vspace{10pt}

## Abstract:

\vspace{5pt}

\fontsize{7}{7}\selectfont
\underline{Aim}: People who inject drugs (PWID) in public have a higher risk of homelessness, incarceration, rushed injection, and overdose than people who do not inject drugs in public. There is limited research on the relationship between public injection and syringe sharing, a risk factor for infectious diseases. The aim of this study was to investigate longitudinal associations between frequency of public injection and syringe sharing among PWID in San Francisco and Los Angeles, California. 

\underline{Methods}: PWID (N=984) were recruited using targeted sampling and completed surveys during three study visits (baseline, 6-month, and 12-month) in 2016 and 2017. The explanatory variable was frequency of having injected in public (never, occasionally/sometimes, or usually/always), and the outcome variable was number of times having used syringes that had already been used by someone else in the past six months. Explanatory and outcome variables were measured across all three timepoints. We used a longitudinal negative binomial mixed-effects model to assess the relationship of interest.

\underline{Results}: At baseline, 78% of participants had injected publicly in the past six months, with 38% of the sample reporting that they usually/always injected publicly. Over a quarter (26%) had injected with a previously used syringe in the six months preceding baseline, with an average of 20.9 instances of receptive syringe sharing during this period. The majority (83%) reported current homelessness at baseline. In multivariable analysis across all timepoints, participants who usually/always injected publicly had 1.71 (95% CI: 1.30, 2.24) times higher counts of receptive syringe sharing over the past six months, compared to those who never publicly injected, controlling for age, gender, homelessness, stimulant injecting, opioid injecting, and binge drinking.
__##########LIZZY TO UPDATE############__

\underline{Conclusion}: Usually/always injecting publicly is associated with a higher frequency of receptive syringe sharing among PWID, suggesting the need for safer environment interventions, such as supervised consumption sites.



\normalsize


# 
\usebeamerfont*{frametitle} \usebeamercolor[fg]{frametitle} Research Question

\vspace{12pt}

\textcolor{black}{Among people who inject drugs (PWID), is frequency of public injection (e.g. on a sidewalk) associated with increased frequency of injecting with a syringe previously used by someone else?}

# Description of Study
This study was a randomized controlled trial to determine efficacy of an intervention to prevent people from helping others to inject drugs for the first time. 984 participants were recruited in San Francisco and Los Angeles using targeted sampling, and completed surveys at three study visits from 2016-2017.
  
For this analysis we ignored study arm and treated data over the three study visits (baseline, 6-month, and 12-month follow-up) as repeated measures. Surveys included data on demographic variables (age, gender, race), as well as time-varying variables including months homeless, types of substances used and routes of administration, frequency of substance use, frequency of injecting in public, and number of times in the past 6 months using syringes that were already used by someone else.

```{r table, include = FALSE}
baseline <- dfs
FU1 <- subset(dfs, FU1=="Yes")
FU2 <- subset(dfs, FU2=="1")
FU1nper <- nrow(FU1)/nrow(baseline)*100
FU2nper <- nrow(FU2)/nrow(baseline)*100
minageb <- min(dfs$AGE)
maxageb <- max(dfs$AGE)
medageb <- median(dfs$AGE)
minage1 <- min(FU1$AGE)
maxage1 <- max(FU1$AGE)
medage1 <- median(FU1$AGE)
minage2 <- min(FU2$AGE)
maxage2 <- max(FU2$AGE)
medage2 <- median(FU2$AGE)
maleb <- nrow(subset(baseline, GENDER=="Male"))
malebp <- maleb/nrow(baseline)*100
femaleb <- nrow(subset(baseline, GENDER=="Female"))
femalebp <- femaleb/nrow(baseline)*100
transb <- nrow(subset(baseline, GENDER=="Transgender" | GENDER=="Other"))
transbp <- transb/nrow(baseline)*100
male1 <- nrow(subset(FU1, GENDER=="Male"))
male1p <- male1/nrow(FU1)*100
female1 <- nrow(subset(FU1, GENDER=="Female"))
female1p <- female1/nrow(FU1)*100
trans1 <- nrow(subset(FU1, GENDER=="Transgender" | GENDER=="Other"))
trans1p <- trans1/nrow(FU1)*100
male2 <- nrow(subset(FU2, GENDER=="Male"))
male2p <- male2/nrow(FU2)*100
female2 <- nrow(subset(FU2, GENDER=="Female"))
female2p <- female2/nrow(FU2)*100
trans2 <- nrow(subset(FU2, GENDER=="Transgender" | GENDER=="Other"))
trans2p <- trans2/nrow(FU2)*100
blackb <- nrow(subset(baseline, RACELG=="Black"))
blackbp <- blackb/nrow(baseline)*100
latinxb <- nrow(subset(baseline, RACELG=="Latinx"))
latinxbp <- latinxb/nrow(baseline)*100
whiteb <- nrow(subset(baseline, RACELG=="White"))
whitebp <- whiteb/nrow(baseline)*100
otherb <- nrow(subset(baseline, RACELG!="Black" & RACELG!="Latinx" & RACELG!="White"))
otherbp <- otherb/nrow(baseline)*100
black1 <- nrow(subset(FU1, RACELG=="Black"))
black1p <- black1/nrow(FU1)*100
latinx1 <- nrow(subset(FU1, RACELG=="Latinx"))
latinx1p <- latinx1/nrow(FU1)*100
white1 <- nrow(subset(FU1, RACELG=="White"))
white1p <- white1/nrow(FU1)*100
other1 <- nrow(subset(FU1, RACELG!="Black" & RACELG!="Latinx" & RACELG!="White"))
other1p <- other1/nrow(FU1)*100
black2 <- nrow(subset(FU2, RACELG=="Black"))
black2p <- black2/nrow(FU2)*100
latinx2 <- nrow(subset(FU2, RACELG=="Latinx"))
latinx2p <- latinx2/nrow(FU2)*100
white2 <- nrow(subset(FU2, RACELG=="White"))
white2p <- white2/nrow(FU2)*100
other2 <- nrow(subset(FU2, RACELG!="Black" & RACELG!="Latinx" & RACELG!="White"))
other2p <- other2/nrow(FU2)*100
injalb <- nrow(subset(baseline, PUBINJ_3cat==2))
injalbp <- injalb/nrow(baseline)*100
injsomeb <- nrow(subset(baseline, PUBINJ_3cat==1))
injsomebp <- injsomeb/nrow(baseline)*100
injnevb <- nrow(subset(baseline, PUBINJ_3cat==0))
injnevbp <- injnevb/nrow(baseline)*100
injal1 <- nrow(subset(FU1, PUBINJ1_3cat==2))
injal1p <- injal1/nrow(FU1)*100
injsome1 <- nrow(subset(FU1, PUBINJ1_3cat==1))
injsome1p <- injsome1/nrow(FU1)*100
injnev1 <- nrow(subset(FU1, PUBINJ1_3cat==0))
injnev1p <- injnev1/nrow(FU1)*100
injal2 <- nrow(subset(FU2, PUBINJ2_3cat==2))
injal2p <- injal2/nrow(FU2)*100
injsome2 <- nrow(subset(FU2, PUBINJ2_3cat==1))
injsome2p <- injsome2/nrow(FU2)*100
injnev2 <- nrow(subset(FU2, PUBINJ2_3cat==0))
injnev2p <- injnev2/nrow(FU2)*100
share0b <- nrow(subset(baseline, RECSHR==0))
share0bp <- share0b/nrow(baseline)*100
share15b <- nrow(subset(baseline, RECSHR>0 & RECSHR<16))
share15bp <- share15b/nrow(baseline)*100
share30b <- nrow(subset(baseline, RECSHR>15 & RECSHR<31))
share30bp <- share30b/nrow(baseline)*100
sharemaxb <- nrow(subset(baseline, RECSHR>30))
sharemaxbp <- sharemaxb/nrow(baseline)*100
share01 <- nrow(subset(FU1, RECSHR1==0))
share01p <- share0b/nrow(FU1)*100
share151 <- nrow(subset(FU1, RECSHR1>0 & RECSHR1<16))
share151p <- share15b/nrow(FU1)*100
share301 <- nrow(subset(FU1, RECSHR1>15 & RECSHR1<31))
share301p <- share30b/nrow(FU1)*100
sharemax1 <- nrow(subset(FU1, RECSHR1>30))
sharemax1p <- sharemaxb/nrow(FU1)*100
share02 <- nrow(subset(FU2, RECSHR2==0))
share02p <- share0b/nrow(FU2)*100
share152 <- nrow(subset(FU2, RECSHR2>0 & RECSHR2<16))
share152p <- share15b/nrow(FU2)*100
share302 <- nrow(subset(FU2, RECSHR2>15 & RECSHR2<31))
share302p <- share30b/nrow(FU2)*100
sharemax2 <- nrow(subset(FU2, RECSHR2>30))
sharemax2p <- sharemaxb/nrow(FU2)*100
home0b <- nrow(subset(baseline, MOSHOME==0))
home0bp <- home0b/nrow(baseline)*100
home6b <- nrow(subset(baseline, MOSHOME>0 & MOSHOME<7))
home6bp <- home6b/nrow(baseline)*100
home12b <- nrow(subset(baseline, MOSHOME>6 & MOSHOME<13))
home12bp <- home12b/nrow(baseline)*100
homeyb <- nrow(subset(baseline, MOSHOME>12))
homeybp <- homeyb/nrow(baseline)*100
home01 <- nrow(subset(FU1, MOSHOME1==0))
home01p <- home01/nrow(FU1)*100
home61 <- nrow(subset(FU1, MOSHOME1>0 & MOSHOME1<7))
home61p <- home61/nrow(FU1)*100
home121 <- nrow(subset(FU1, MOSHOME1>6 & MOSHOME1<13))
home121p <- home121/nrow(FU1)*100
homey1 <- nrow(subset(FU1, MOSHOME1>12))
homey1p <- homey1/nrow(FU1)*100
home02 <- nrow(subset(FU2, MOSHOM2==0))
home02p <- home02/nrow(FU2)*100
home62 <- nrow(subset(FU2, MOSHOM2>0 & MOSHOM2<7))
home62p <- home62/nrow(FU2)*100
home122 <- nrow(subset(FU2, MOSHOM2>6 & MOSHOM2<13))
home122p <- home122/nrow(FU2)*100
homey2 <- nrow(subset(FU2, MOSHOM2>12))
homey2p <- homey2/nrow(FU2)*100
stimb <- sum(baseline$ANYSTIM)
stimbp <- stimb/nrow(baseline)*100
stim1 <- sum(FU1$ANYSTIM1)
stim1p <- stim1/nrow(FU1)*100
stim2 <- sum(FU2$ANYSTIM2)
stim2p <- stim2/nrow(FU2)*100
opiateb <- sum(baseline$ANYOPIATE)
opiatebp <- opiateb/nrow(baseline)*100
opiate1 <- sum(FU1$ANYOPIATE1)
opiate1p <- opiate1/nrow(FU1)*100
opiate2 <- sum(FU2$ANYOPIATE2)
opiate2p <- opiate2/nrow(FU2)*100
bingeb <- sum(baseline$binge, na.rm=TRUE)
bingebp <- bingeb/nrow(baseline)*100
binge1 <- sum(FU1$binge1, na.rm=TRUE)
binge1p <- binge1/nrow(FU1)*100
binge2 <- sum(FU2$binge2, na.rm=TRUE)
binge2p <- binge2/nrow(FU2)*100
```

# Description of Sample
One of the biggest challenges of this analysis was appropriately dealing with informative censoring with large loss-to-follow-up. <!--The table below shows the number of people and key variables at each study timepoint (note that 6 participants were dropped from the analysis due to substantial amounts of missing data):-->

\fontsize{5}{5}\selectfont

| \textcolor{white}{.}| \textcolor{white}{.} | Baseline | 6-month F/U | 12-month F/U |
| ----------- | -------- | --------- | --------| --------|
| Total |  | `r nrow(baseline)` (100%) | `r nrow(FU1)` (`r round(FU1nper, 1)`%) | `r nrow(FU2)` (`r round(FU2nper, 1)`%) |
|  |  |  | | | 
|     | Min | `r minageb` | `r minage1` | `r minage2` |
| Age | Median | `r medageb` | `r medage1` | `r medage2` |
|     | Max | `r maxageb` | `r maxage1` | `r maxage2` |
|  |  |  | | |
|     | Male | `r maleb` (`r round(malebp, 1)`%) |  `r male1` (`r round(male1p, 1)`%) |  `r male2` (`r round(male2p, 1)`%) | 
| Gender | Female | `r femaleb` (`r round(femalebp, 1)`%) |  `r female1` (`r round(female1p, 1)`%) |  `r female2` (`r round(male2p, 1)`%) | 
|     | Transgender | `r transb` (`r round(transbp, 1)`%) |  `r trans1` (`r round(trans1p, 1)`%) |  `r trans2` (`r round(trans2p, 1)`%) | 
|  |  |  | | |
|     | Black | `r blackb` (`r round(blackbp, 1)`%) |  `r black1` (`r round(black1p, 1)`%) |  `r black2` (`r round(black2p, 1)`%) | 
| Race | Latinx | `r latinxb` (`r round(latinxbp, 1)`%) |  `r latinx1` (`r round(latinx1p, 1)`%) |  `r latinx2` (`r round(latinx2p, 1)`%) | 
|     | White | `r whiteb` (`r round(whitebp, 1)`%) |  `r white1` (`r round(white1p, 1)`%) |  `r white2` (`r round(white2p, 1)`%) | 
|     | Other | `r otherb` (`r round(otherbp, 1)`%) |  `r other1` (`r round(other1p, 1)`%) |  `r other2` (`r round(other2p, 1)`%) |  
|  |  |  | | | 
|     | Always/Usually | `r injalb` (`r round(injalbp, 1)`%) |  `r injal1` (`r round(injal1p, 1)`%) |  `r injal2` (`r round(injal2p, 1)`%) | 
| Public Injection | Sometimes/Occasionally | `r injsomeb` (`r round(injsomebp, 1)`%) |  `r injal1` (`r round(injsome1p, 1)`%) |  `r injsome2` (`r round(injsome2p, 1)`%) | 
|     | Never | `r injnevb` (`r round(injnevbp, 1)`%) |  `r injnev1` (`r round(injnev1p, 1)`%) |  `r injnev2` (`r round(injnev2p, 1)`%) | 
|  |  |  | | |
|     | 0 | `r share0b` (`r round(share0bp, 1)`%) |  `r share01` (`r round(share01p, 1)`%) |  `r share02` (`r round(share02p, 1)`%) | 
| Times Sharing | 1 - 15 | `r share15b` (`r round(share15bp, 1)`%) |  `r share151` (`r round(share151p, 1)`%) |  `r share152` (`r round(share152p, 1)`%) | 
|     | 16 - 30 | `r share30b` (`r round(share30bp, 1)`%) |  `r share301` (`r round(share301p, 1)`%) |  `r share302` (`r round(share302p, 1)`%) | 
|     | 31+ | `r sharemaxb` (`r round(sharemaxbp, 1)`%) |  `r sharemax1` (`r round(sharemax1p, 1)`%) |  `r sharemax2` (`r round(sharemax2p, 1)`%) | 
|  |  |  | | |
|     | 0 | `r home0b` (`r round(home0bp, 1)`%) |  `r home01` (`r round(home01p, 1)`%) |  `r home02` (`r round(home02p, 1)`%) | 
| Months Homeless | 1 - 6 | `r home6b` (`r round(home6bp, 1)`%) |  `r home61` (`r round(home61p, 1)`%) |  `r home62` (`r round(home62p, 1)`%) | 
|     | 7 - 12 | `r home12b` (`r round(home12bp, 1)`%) |  `r home121` (`r round(home121p, 1)`%) |  `r home122` (`r round(home122p, 1)`%) | 
|     | 13+ | `r homeyb` (`r round(homeybp, 1)`%) |  `r homey1` (`r round(homey1p, 1)`%) |  `r homey2` (`r round(homey2p, 1)`%) | 
|  |  |  | | |
|     | Used stimulants | `r stimb` (`r round(stimbp, 1)`%) |  `r stim1` (`r round(stim1p, 1)`%) |  `r stim2` (`r round(stim2p, 1)`%) | 
| Substance Use | Used opiates | `r opiateb` (`r round(opiatebp, 1)`%) |  `r opiate1` (`r round(opiate1p, 1)`%) |  `r opiate2` (`r round(opiate2p, 1)`%) | 
|     | Binge drinking | `r bingeb` (`r round(bingebp, 1)`%) |  `r binge1` (`r round(binge1p, 1)`%) |  `r binge2` (`r round(binge2p, 1)`%) | 
\normalsize

# Statistical Model
We converted our research question into a parameter of interest using a series of longitudinal regression models where:
\vspace{-9pt}

\begin{align*}
log (E[Y|\textbf{X}]) &= \beta_0 + \beta_{0i} + (\beta_1 + \beta_{1i} + \beta_{1j}) X_{1ij} + (\beta_2 + \beta_{2i} + \beta_{2j}) X_{2ij} + \\
&\ \ \ \beta_3X_3 + \beta_4X_4 + (\beta_5 + \beta_{5i} + \beta_{5j}) X_{5ij} + \\
&\ \ \ (\beta_6 + \beta_{6i} + \beta_{6j}) X_{6ij} + (\beta_7 + \beta_{7i} + \beta_{7j}) X_{7ij}
\end{align*}

\small
where:

\vspace{-4pt}

* Y = number of times shared syringes (outcome)
* $X_1$ = frequency of public injection (exposure)
* $X_2$ = homelessness status
* $X_3$ = gender
* $X_4$ = age
* $X_5$ = any stimulant injection
* $X_6$ = any opiate injection
* $X_7$ = any binge drinking

All variables have a recall period of 6 months, where applicable. 

\normalsize

# Methods used to fit model and derive inference
\footnotesize
We fit 3 models to answer this question: GEE, and mixed effects models using both poisson and negative binomial distributions.

The \textbf{GEE model} estimated the marginal effects of public injection frequency on receptive syringe sharing across the three timepoints, controlling for homelessness, gender, age, stimulant or opiate injection, and binge drinking. GEEs treat the correlation between subjects as a "nuisance" parameter. We did this using the $\tt{gee}$ package in R, assuming an exchangeable correlation structure and a poisson distribution. 

The \textbf{mixed effects models} estimate the marginal longitudinal effect of public injection frequency on receptive syringe sharing, controlling for the same confounders, but allow for both a random intercept term and a random effect term for frequency of public injection (our exposure), homelessness, and the substance use variables. These models use maximum likelihood to estimate the coefficients in the model, but rely on correct specification of both the mean model and the correlation structure of the residual errors. We did this using the $\tt{glmer}$ function in the $\tt{MASS}$ package in R, specifying $\tt{family = "poisson"}$, and using the $\tt{glmer.nb}$ function in the $\tt{lme4}$ package in R for the negative binomial model. For the mixed models we calculated 95% confidence intervals using the sandwich estimator. 

\normalsize

<!--
Analysis with no weights:-->

```{r analysis no weights, include=FALSE, cache=TRUE}
######################################################################
########NOTE THAT RIGHT NOW WE ARE NOT REWEIGHTING THE SAMPLE#########
######################################################################

# #gee model
#modelgee <- gee(TIMESHARE ~ PUBINJord*YRSHOME + GENDER + AGE + ANYSTIM + ANYOPIATE + binge, SUBJECT, data = dfslong, family = poisson, corstr = "exchangeable", na.action = na.omit)
#summary(modelgee)

# #mixed effects models

# #poisson
#modelpoisson <- glmer(TIMESHARE ~ PUBINJord*YRSHOME + GENDER + AGE + ANYSTIM + ANYOPIATE + binge + (1|SUBJECT), family = "poisson", data = dfslong, na.action = na.omit)
#summary(modelpoisson)
#exp(summary(modelpoisson)$coefficients)

# #negative binomial
#modelnb <- glmer.nb(TIMESHARE ~ PUBINJord*YRSHOME + GENDER + AGE + ANYSTIM + ANYOPIATE + binge + (1|SUBJECT), data = dfslong, na.action = na.omit)
#summary(modelnb)
#exp(summary(modelnb)$coefficients)

# #using confint.merMod from lme4 to get 95% CI for public injecting. I think we want method="profile" instead of method="Wald" but I couldn't get it to work.
#est <- confint(modelnb, "PUBINJord", level=0.95, method="Wald")
#exp(est)
```

<!--Playing around with public injecting as categorical instead of ordinal.
-->
```{r models, include = FALSE, cache = TRUE}
#gee
modelgee_categorical <- gee(TIMESHARE ~ PUBINJ_3cat + HOMELESS + GENDER + AGE + ANYSTIM + ANYOPIATE + binge, SUBJECT, data = dfslong, family = poisson, corstr = "exchangeable", na.action = na.omit)
summary(modelgee_categorical)
gee.names <- data.frame(names(modelgee_categorical$coefficients))
gee.out <- data.frame(coef(summary(modelgee_categorical)))
gee.out <- data.frame(gee.out, pvalue=2*(1-pnorm(abs(gee.out[,5]))))
gee.out <- data.frame(Predictor=gee.names[,1], Est.GEE=gee.out[,1], RobustSE.GEE=gee.out[,4], pvalue.GEE=gee.out[,6]); gee.out

#poisson
modelpoisson_categorical <- glmer(TIMESHARE ~ PUBINJ_3cat + HOMELESS + GENDER + AGE + ANYSTIM + ANYOPIATE + binge + (1|SUBJECT), family = "poisson", data = dfslong, na.action = na.omit)
summary(modelpoisson_categorical)
pois.pvalue <- data.frame(summary(modelpoisson_categorical)$coefficients)
pois.est <- data.frame(exp(summary(modelpoisson_categorical)$coefficients))
pois.out <- data.frame(Est.MM.Pois=pois.est[,1], pvalue.MM.Pois=pois.pvalue[,4]); pois.out

#negative binomial
modelnb_categorical <- glmer.nb(TIMESHARE ~ PUBINJ_3cat + HOMELESS + GENDER + AGE + ANYSTIM + ANYOPIATE + binge + (1|SUBJECT), data = dfslong, na.action = na.omit)
summary(modelnb_categorical)
NB.pvalue <- data.frame(summary(modelnb_categorical)$coefficients)
NB.est <- data.frame(exp(summary(modelnb_categorical)$coefficients))
NB.out <- data.frame(Est.MM.NB=NB.est[,1], pvalue.MM.NB=NB.pvalue[,4]); NB.out

# #using confint.merMod from lme4 to get 95% CI for public injecting. I think we want method="profile" instead of method="Wald" but I couldn't get it to work.
# est_categorical <- confint(modelnb_categorical, c("PUBINJ_3cat1", "PUBINJ_3cat2"), level=0.95, method="Wald")
# exp(est_categorical)

# #NB sandwich estimator
#robVar_nb <- vcovCL(modelnb_categorical, cluster = dfslong$SUBJECT, sandwich = T)
#SE_nb <- sqrt(diag(robVar_nb))
#out.NB <- data.frame(Est.NB = coef(modelnb_categorical), SE.NB = SE_nb)
#out.NB <- data.frame(out.NB, pvalue.NB = 2*(1-pnorm(abs(out.NB[,2]))))

#all the model output
out.all <- data.frame(gee.out, pois.out, NB.out); out.all
```

# Unformatted output
\fontsize{6}{6}\selectfont

```{r output, ECHO=TRUE}
out.all <- out.all[-1,]; out.all
```


#Compare models 

%%%%%%%%%%%%%%%%%%%%%%%%%%%  
GET THIS WORKING - SHELLEY  
%%%%%%%%%%%%%%%%%%%%%%%%%%% 

<!--Compare poisson and negative binomial mixed models. NB is better. Less negative log likelihood and lower AIC.-->
```{r compare, include = FALSE}
lrtest(modelpoisson_categorical, modelnb_categorical)
AIC(modelpoisson_categorical, modelnb_categorical)
```

# Results
Make nice tables presenting the results. Attempt to make a compelling graph that addresses the question of interest.

%%%%%%%%%%%%%%%%%%%%%%%%%  
MAKE THE TABLE OF RESULTS - Shelley  
%%%%%%%%%%%%%%%%%%%%%%%%%  
  
%%%%%%%%%%%%%%%  
MAKE THE GRAPH - Lizzy  
%%%%%%%%%%%%%%%  

# Discussion
Interpret your results both with regard to the substantive question of interest as well as any statistical issues.

%%%%%%%%%%%%%%  
DO THIS SLIDE - Lizzy  
%%%%%%%%%%%%%%  


